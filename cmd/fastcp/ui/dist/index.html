<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FastCP - Server Control Panel</title>
    <link rel="icon" type="image/png" href="/assets/icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#eef4ff', 100: '#dce8ff', 200: '#bfd3ff', 300: '#93b6ff', 400: '#5f90ff', 500: '#004aad', 600: '#003f94', 700: '#00357c', 800: '#002c66', 900: '#001f47' },
                    }
                }
            }
        }
    </script>
    <style>
        [x-cloak] { display: none !important; }
        html { font-size: 15px; }
        * { -webkit-tap-highlight-color: transparent; }
        input,
        select,
        textarea {
            font-size: 0.875rem;
        }
        input:focus,
        select:focus,
        textarea:focus {
            outline: none !important;
            box-shadow: none !important;
        }
        th, td {
            padding-top: 0.65rem !important;
            padding-bottom: 0.65rem !important;
        }
        button:focus,
        button:focus-visible,
        [role="button"]:focus,
        [role="button"]:focus-visible,
        a:focus,
        a:focus-visible {
            outline: none !important;
            box-shadow: none !important;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen" x-data="app()" x-cloak>
    <!-- Login Screen -->
    <div x-show="!authenticated" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-gray-50 via-white to-gray-100">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border border-gray-200">
            <div class="text-center mb-8">
                <div class="w-full mb-4 p-1">
                    <img src="/assets/logo.svg" alt="FastCP logo" class="w-full h-auto max-h-14 object-contain">
                </div>
                <p class="text-gray-600 mt-2">Modern & Performant PHP Control Panel</p>
            </div>
            
            <form @submit.prevent="login">
                <div x-show="new URLSearchParams(window.location.search).get('redirect') === 'phpmyadmin'" 
                     class="bg-blue-50 border border-blue-200 text-blue-700 px-4 py-3 rounded-lg mb-4">
                    <span>Please log in to access phpMyAdmin</span>
                </div>
                <div x-show="error" class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4">
                    <span x-text="error"></span>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2">Username</label>
                    <input type="text" x-model="username" 
                           class="w-full px-4 py-3 bg-white border border-gray-300 rounded-lg focus:outline-none focus:border-primary-500 focus:ring-1 focus:ring-primary-500 text-gray-900 placeholder-gray-400"
                           placeholder="System username" required>
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-medium mb-2">Password</label>
                    <input type="password" x-model="password"
                           class="w-full px-4 py-3 bg-white border border-gray-300 rounded-lg focus:outline-none focus:border-primary-500 focus:ring-1 focus:ring-primary-500 text-gray-900 placeholder-gray-400"
                           placeholder="System password" required>
                </div>
                
                <button type="submit" :disabled="loading"
                        class="w-full bg-primary-500 text-white py-3 px-4 rounded-lg hover:bg-primary-600 disabled:opacity-50 font-medium transition-colors duration-150">
                    <span x-show="!loading">Sign In</span>
                    <span x-show="loading" class="flex items-center justify-center">
                        <svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Signing in...
                    </span>
                </button>
            </form>
            
            <p class="text-center text-gray-500 text-sm mt-6">
                Use your Linux system credentials
            </p>
        </div>
    </div>

    <!-- Dashboard with Sidebar -->
    <div x-show="authenticated" class="min-h-screen flex">
        <!-- Sidebar -->
        <aside class="w-64 bg-white border-r border-gray-200 fixed inset-y-0 left-0 z-30 flex flex-col">
            <!-- Logo -->
            <div class="flex items-center h-16 px-4 border-b border-gray-200">
                <div class="w-full rounded-lg overflow-hidden">
                    <img src="/assets/logo.svg" alt="FastCP logo" class="w-full h-auto max-h-10 object-contain">
                </div>
            </div>

            <!-- Navigation -->
            <nav class="flex-1 py-4 overflow-y-auto">
                <div class="px-4 mb-2">
                    <span class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Main</span>
                </div>
                
                <a href="#dashboard" @click="navigate('dashboard')" 
                   :class="tab === 'dashboard' ? 'bg-primary-50 text-primary-700 border-r-2 border-primary-500' : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'"
                   class="flex items-center px-4 py-3 transition-colors duration-150">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"></path>
                    </svg>
                    Dashboard
                </a>

                <a href="#sites" @click="navigate('sites')" 
                   :class="tab === 'sites' ? 'bg-primary-50 text-primary-700 border-r-2 border-primary-500' : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'"
                   class="flex items-center px-4 py-3 transition-colors duration-150">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path>
                    </svg>
                    Sites
                    <span x-show="sites.length > 0" class="ml-auto bg-gray-100 text-gray-600 text-xs px-2 py-0.5 rounded-full" x-text="sites.length"></span>
                </a>

                <a href="#databases" @click="navigate('databases')" 
                   :class="tab === 'databases' ? 'bg-primary-50 text-primary-700 border-r-2 border-primary-500' : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'"
                   class="flex items-center px-4 py-3 transition-colors duration-150">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path>
                    </svg>
                    Databases
                    <span x-show="databases.length > 0" class="ml-auto bg-gray-100 text-gray-600 text-xs px-2 py-0.5 rounded-full" x-text="databases.length"></span>
                </a>

                <a href="#backups" @click="navigate('backups')"
                   :class="tab === 'backups' ? 'bg-primary-50 text-primary-700 border-r-2 border-primary-500' : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'"
                   class="flex items-center px-4 py-3 transition-colors duration-150">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 18a4 4 0 010-8 5.5 5.5 0 0110.7-1.6A4 4 0 1117 18H7z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11v6m0 0l-2-2m2 2l2-2"></path>
                    </svg>
                    Backups
                </a>

                <a href="#ssh" @click="navigate('ssh')" 
                   :class="tab === 'ssh' ? 'bg-primary-50 text-primary-700 border-r-2 border-primary-500' : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'"
                   class="flex items-center px-4 py-3 transition-colors duration-150">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                    </svg>
                    SSH & SFTP
                </a>

                <a href="#cron" @click="navigate('cron')" 
                   :class="tab === 'cron' ? 'bg-primary-50 text-primary-700 border-r-2 border-primary-500' : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'"
                   class="flex items-center px-4 py-3 transition-colors duration-150">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Cron Jobs
                    <span x-show="cronJobs.length > 0" class="ml-auto bg-gray-100 text-gray-600 text-xs px-2 py-0.5 rounded-full" x-text="cronJobs.length"></span>
                </a>

                <div x-show="user?.is_admin" class="mt-6">
                    <div class="px-4 mb-2">
                        <span class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Admin</span>
                    </div>
                    
                    <a href="#users" @click="navigate('users')" 
                       :class="tab === 'users' ? 'bg-primary-50 text-primary-700 border-r-2 border-primary-500' : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'"
                       class="flex items-center px-4 py-3 transition-colors duration-150">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                        </svg>
                        Users
                    </a>

                    <a href="#system" @click="navigate('system')" 
                       :class="tab === 'system' ? 'bg-primary-50 text-primary-700 border-r-2 border-primary-500' : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'"
                       class="flex items-center px-4 py-3 transition-colors duration-150">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path>
                        </svg>
                        System
                    </a>
                </div>
            </nav>

            <!-- User section -->
            <div class="p-4 border-t border-gray-200">
                <!-- Update notification -->
                <div x-show="user?.is_admin && updateInfo?.update_available" class="mb-3 p-3 bg-green-50 border border-green-200 rounded-lg">
                    <div class="flex items-center justify-between">
                        <span class="text-green-700 text-sm font-medium" x-text="updateInfo.latest_version + ' available'"></span>
                        <button @click="performUpdate()" :disabled="updateLoading"
                                class="px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600 disabled:opacity-50">
                            <span x-show="!updateLoading">Update</span>
                            <span x-show="updateLoading" x-text="`Updating ${Math.round(updateProgress || 0)}%`"></span>
                        </button>
                    </div>
                    <div x-show="updateLoading" class="mt-2">
                        <p class="text-xs text-green-700 mb-1" x-text="updateStatus || 'Preparing update...'"></p>
                        <div class="w-full h-1.5 bg-green-100 rounded-full overflow-hidden">
                            <div class="h-full bg-green-500 transition-all duration-300" :style="`width: ${Math.max(3, Math.min(100, Math.round(updateProgress || 0)))}%`"></div>
                        </div>
                    </div>
                </div>

                <div class="flex items-center">
                    <div class="w-10 h-10 bg-primary-500 rounded-full flex items-center justify-center text-white font-medium">
                        <span x-text="user?.username?.charAt(0).toUpperCase()"></span>
                    </div>
                    <div class="ml-3 flex-1">
                        <p class="text-gray-800 text-sm font-medium" x-text="user?.username"></p>
                        <p class="text-gray-500 text-xs" x-text="user?.is_admin ? 'Administrator' : 'User'"></p>
                        <p x-show="user?.is_admin && updateInfo?.current_version" class="text-gray-400 text-[11px]" x-text="`FastCP ${updateInfo.current_version}`"></p>
                    </div>
                    <button @click="logout" class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors" title="Sign out">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 ml-64">
            <!-- Top Bar -->
            <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-8 sticky top-0 z-20">
                <div>
                    <h1 class="text-xl font-semibold text-gray-800" x-text="tabTitle"></h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div x-show="user?.is_admin && updateInfo?.current_version" class="hidden sm:block text-xs text-gray-500">
                        <span x-text="`Version ${updateInfo.current_version}`"></span>
                    </div>
                    <button x-show="user?.is_admin"
                            @click="checkUpdate(true)"
                            :disabled="updateChecking || updateLoading"
                            class="inline-flex items-center justify-center w-8 h-8 rounded-lg border border-gray-200 text-gray-500 hover:text-gray-700 hover:bg-gray-50 disabled:opacity-50"
                            title="Check updates now"
                            aria-label="Check updates now">
                        <svg x-show="!updateChecking" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 2v6h-6"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12a9 9 0 0115-6.7L21 8"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 22v-6h6"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-15 6.7L3 16"></path>
                        </svg>
                        <svg x-show="updateChecking" class="w-4 h-4 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                        </svg>
                    </button>
                    <div x-show="updateError" class="text-sm text-red-600" x-text="updateError"></div>
                </div>
            </header>

            <!-- Page Content -->
            <div class="p-8">
                <div x-show="user?.is_impersonating" class="mb-4 rounded-lg border border-amber-200 bg-amber-50 px-4 py-3">
                    <div class="flex flex-wrap items-center gap-3">
                        <div class="text-sm text-amber-800">
                            <span class="font-semibold">Impersonation mode:</span>
                            <span>you are logged in as </span>
                            <span class="font-semibold" x-text="user?.username"></span>
                            <span>, started by </span>
                            <span class="font-semibold" x-text="user?.impersonated_by || 'admin'"></span>.
                        </div>
                        <button @click="stopImpersonation()"
                                :disabled="impersonationStopping"
                                class="ml-auto px-3 py-1.5 text-xs border border-amber-300 text-amber-800 bg-white rounded-lg hover:bg-amber-100 disabled:opacity-50">
                            <span x-text="impersonationStopping ? 'Returning...' : 'Return to Admin'"></span>
                        </button>
                    </div>
                    <p x-show="user?.impersonation_expires_at" class="mt-1 text-[11px] text-amber-700">
                        Expires: <span x-text="formatDateTime(user?.impersonation_expires_at)"></span>
                    </p>
                </div>

                <!-- Dashboard Tab -->
                <div x-show="tab === 'dashboard'">
                    <div class="mb-6 flex items-center justify-between">
                        <div>
                            <h2 class="text-lg font-semibold text-gray-800">Server Overview</h2>
                            <p class="text-sm text-gray-500">Live runtime and platform information</p>
                        </div>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium"
                              :class="(systemStatus?.load_average || 0) > 2 ? 'bg-red-50 text-red-700 border border-red-200' : (systemStatus?.load_average || 0) > 1 ? 'bg-amber-50 text-amber-700 border border-amber-200' : 'bg-green-50 text-green-700 border border-green-200'"
                              x-text="(systemStatus?.load_average || 0) > 2 ? 'High load' : (systemStatus?.load_average || 0) > 1 ? 'Moderate load' : 'Healthy'"></span>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-7 gap-4 mb-8">
                        <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4">
                            <p class="text-xs font-medium text-gray-500">CPU Load</p>
                            <p class="text-xl font-semibold text-gray-900 mt-1" x-text="systemStatus?.load_average?.toFixed(2) || '0.00'"></p>
                            <p class="text-[11px] text-gray-400 mt-1">1m average</p>
                        </div>
                        <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4">
                            <p class="text-xs font-medium text-gray-500">Memory</p>
                            <p class="text-xl font-semibold text-gray-900 mt-1" x-text="systemStatus?.memory_total ? ((systemStatus.memory_used / systemStatus.memory_total) * 100).toFixed(1) + '%' : '0%'"></p>
                            <p class="text-[11px] text-gray-400 mt-1" x-text="formatBytes(systemStatus?.memory_used) + ' / ' + formatBytes(systemStatus?.memory_total)"></p>
                        </div>
                        <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4">
                            <p class="text-xs font-medium text-gray-500">Disk</p>
                            <p class="text-xl font-semibold text-gray-900 mt-1" x-text="systemStatus?.disk_total ? ((systemStatus.disk_used / systemStatus.disk_total) * 100).toFixed(1) + '%' : '0%'"></p>
                            <p class="text-[11px] text-gray-400 mt-1" x-text="formatBytes(systemStatus?.disk_used) + ' / ' + formatBytes(systemStatus?.disk_total)"></p>
                        </div>
                        <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4">
                            <p class="text-xs font-medium text-gray-500">Uptime</p>
                            <p class="text-lg font-semibold text-gray-900 mt-1" x-text="formatUptime(systemStatus?.uptime)"></p>
                            <p class="text-[11px] text-gray-400 mt-1">Since last reboot</p>
                        </div>
                        <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4">
                            <p class="text-xs font-medium text-gray-500">Total Users</p>
                            <p class="text-xl font-semibold text-gray-900 mt-1" x-text="(systemStatus?.total_users ?? 0)"></p>
                            <p class="text-[11px] text-gray-400 mt-1">All accounts</p>
                        </div>
                        <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4">
                            <p class="text-xs font-medium text-gray-500">Total Websites</p>
                            <p class="text-xl font-semibold text-gray-900 mt-1" x-text="(systemStatus?.total_websites ?? 0)"></p>
                            <p class="text-[11px] text-gray-400 mt-1">Configured sites</p>
                        </div>
                        <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4">
                            <p class="text-xs font-medium text-gray-500">Total Databases</p>
                            <p class="text-xl font-semibold text-gray-900 mt-1" x-text="(systemStatus?.total_databases ?? 0)"></p>
                            <p class="text-[11px] text-gray-400 mt-1">Managed MySQL DBs</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                        <div class="xl:col-span-2 bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-5">Platform Details</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-3">
                                <div class="flex justify-between py-2 border-b border-gray-100">
                                    <span class="text-gray-500">Hostname</span>
                                    <span class="font-mono text-gray-800" x-text="systemStatus?.hostname || '-'"></span>
                                </div>
                                <div class="flex justify-between py-2 border-b border-gray-100">
                                    <span class="text-gray-500">Operating System</span>
                                    <span class="text-gray-800" x-text="systemStatus?.os || '-'"></span>
                                </div>
                                <div class="flex justify-between py-2 border-b border-gray-100">
                                    <span class="text-gray-500">Kernel</span>
                                    <span class="font-mono text-gray-800" x-text="systemStatus?.kernel_version || '-'"></span>
                                </div>
                                <div class="flex justify-between py-2 border-b border-gray-100">
                                    <span class="text-gray-500">Architecture</span>
                                    <span class="font-mono text-gray-800" x-text="systemStatus?.architecture || '-'"></span>
                                </div>
                                <div class="flex justify-between py-2 border-b border-gray-100">
                                    <span class="text-gray-500">Caddy Version</span>
                                    <span class="font-mono text-gray-800" x-text="systemStatus?.caddy_version || '-'"></span>
                                </div>
                                <div class="flex justify-between py-2 border-b border-gray-100">
                                    <span class="text-gray-500">MySQL Version</span>
                                    <span class="font-mono text-gray-800" x-text="systemStatus?.mysql_version || '-'"></span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-5">PHP Runtime</h3>
                            <div class="mb-4">
                                <p class="text-xs uppercase tracking-wide text-gray-500 mb-1">Default Version</p>
                                <p class="text-2xl font-semibold text-gray-900 font-mono" x-text="'PHP ' + (systemStatus?.php_version || '-')"></p>
                            </div>
                            <div class="pt-3 border-t border-gray-100">
                                <p class="text-xs uppercase tracking-wide text-gray-500 mb-3">Installed Versions</p>
                                <div class="flex flex-wrap gap-2">
                                    <template x-for="version in (systemStatus?.php_available_versions || [])" :key="version">
                                        <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-primary-50 text-primary-700 border border-primary-100" x-text="'PHP ' + version"></span>
                                    </template>
                                    <span x-show="!systemStatus?.php_available_versions || systemStatus.php_available_versions.length === 0" class="text-sm text-gray-500">No PHP versions detected</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sites Tab -->
                <div x-show="tab === 'sites'">
                    <!-- Root user warning -->
                    <div x-show="user?.username === 'root'" class="mb-6 bg-amber-50 border border-amber-200 rounded-xl p-4">
                        <div class="flex items-start">
                            <svg class="w-5 h-5 text-amber-500 mt-0.5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                            <div>
                                <h4 class="font-semibold text-amber-800">Website creation disabled for root</h4>
                                <p class="text-sm text-amber-700 mt-1">For security reasons, the root user cannot create websites. Running PHP processes as root is a security risk. Please log in as or create a non-root admin user (e.g., <strong>fastcp</strong>) to manage websites.</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                        <div class="flex items-center gap-4">
                            <div class="relative">
                                <input type="text" x-model="sitesSearch" @input.debounce.300ms="searchSites()" 
                                       placeholder="Search sites..." 
                                       class="pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-primary-500 w-64">
                                <svg class="w-5 h-5 text-gray-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                            <span class="text-sm text-gray-500" x-text="sitesTotal + ' site' + (sitesTotal !== 1 ? 's' : '')"></span>
                        </div>
                        <button x-show="user?.username !== 'root'" @click="openCreateSiteModal()" 
                                class="inline-flex items-center px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Create Site
                        </button>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Domain</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Type</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">SSL</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Created</th>
                                    <th class="px-6 py-4 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                <template x-for="site in sites" :key="site.id">
                                    <tr class="hover:bg-gray-50 transition-colors">
                                        <td class="px-6 py-4">
                                            <div>
                                                <a :href="(site.force_https === false ? 'http://' : 'https://') + site.domain" target="_blank" class="text-primary-600 hover:text-primary-700 font-medium" x-text="site.domain"></a>
                                                <div x-show="site.domains && site.domains.length > 1" class="text-xs text-gray-400 mt-1">
                                                    <span x-text="'+' + (site.domains.length - 1) + ' more domain' + (site.domains.length > 2 ? 's' : '')"></span>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="inline-flex items-center justify-center">
                                                <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold border"
                                                      :class="site.site_type === 'wordpress' ? 'bg-blue-50 text-blue-700 border-blue-200' : 'bg-gray-50 text-gray-700 border-gray-200'">
                                                    <span class="w-1.5 h-1.5 rounded-full mr-1.5"
                                                          :class="site.site_type === 'wordpress' ? 'bg-blue-500' : 'bg-gray-500'"></span>
                                                    <span x-text="site.site_type === 'wordpress' ? 'WordPress' : 'PHP'"></span>
                                                </span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="flex items-center gap-2"
                                                 :class="site.ssl_valid ? 'text-green-600' : (site.ssl_status === 'disabled' ? 'text-gray-500' : 'text-amber-600')"
                                                 :title="site.ssl_reason || (site.ssl_valid ? 'SSL issued and trusted' : 'SSL not issued or not trusted')">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                                                </svg>
                                                <span class="text-xs font-medium" x-text="site.ssl_valid ? 'Valid' : (site.ssl_status === 'disabled' ? 'Disabled' : 'Not Ready')"></span>
                                            </div>
                                            <p x-show="site.ssl_reason" class="mt-1 text-[11px] text-gray-500 max-w-[280px] truncate" :title="site.ssl_reason" x-text="site.ssl_reason"></p>
                                        </td>
                                        <td class="px-6 py-4 text-sm text-gray-500" x-text="formatDate(site.created_at)"></td>
                                        <td class="px-6 py-4 text-right">
                                            <div class="inline-flex items-center gap-2">
                                                <button @click="openSiteSettings(site)"
                                                        :disabled="deletingSiteId === site.id"
                                                        class="inline-flex items-center justify-center w-9 h-9 rounded-lg border border-gray-200 text-primary-600 hover:bg-primary-50 hover:border-primary-200 transition-colors"
                                                        :class="deletingSiteId === site.id ? 'opacity-50 cursor-not-allowed' : ''"
                                                        title="Site settings" aria-label="Site settings">
                                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M7 12h10M10 18h4"></path>
                                                        <circle cx="9" cy="6" r="1.5" fill="currentColor"></circle>
                                                        <circle cx="15" cy="12" r="1.5" fill="currentColor"></circle>
                                                        <circle cx="12" cy="18" r="1.5" fill="currentColor"></circle>
                                                    </svg>
                                                </button>
                                                <button @click="deleteSite(site)"
                                                        :disabled="deletingSiteId === site.id"
                                                        class="inline-flex items-center justify-center w-9 h-9 rounded-lg border border-red-200 text-red-600 hover:bg-red-50 hover:border-red-300 transition-colors"
                                                        :class="deletingSiteId === site.id ? 'opacity-50 cursor-not-allowed' : ''"
                                                        title="Delete site" aria-label="Delete site">
                                                    <svg x-show="deletingSiteId === site.id" class="animate-spin w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                    </svg>
                                                    <svg x-show="deletingSiteId !== site.id" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M9 7h6m-5-3h4a1 1 0 011 1v2H9V5a1 1 0 011-1z"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </template>
                                <tr x-show="sites.length === 0">
                                    <td colspan="5" class="px-6 py-16 text-center">
                                        <div class="flex flex-col items-center">
                                            <svg class="w-12 h-12 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9"></path>
                                            </svg>
                                            <p class="text-gray-500 mb-2">No sites yet</p>
                                            <button x-show="user?.username !== 'root'" @click="openCreateSiteModal()" class="text-primary-600 hover:text-primary-700 text-sm font-medium">Create your first site</button>
                                            <p x-show="user?.username === 'root'" class="text-gray-400 text-sm">Log in as a non-root user to create websites</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Sites Pagination -->
                    <div x-show="sitesTotal > sitesLimit" class="flex items-center justify-between mt-4 px-2">
                        <div class="text-sm text-gray-500">
                            Showing <span x-text="((sitesPage - 1) * sitesLimit) + 1"></span> to <span x-text="Math.min(sitesPage * sitesLimit, sitesTotal)"></span> of <span x-text="sitesTotal"></span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button @click="goToSitesPage(sitesPage - 1)" :disabled="sitesPage <= 1"
                                    class="px-3 py-1 border border-gray-200 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                Previous
                            </button>
                            <span class="text-sm text-gray-600">Page <span x-text="sitesPage"></span> of <span x-text="sitesTotalPages()"></span></span>
                            <button @click="goToSitesPage(sitesPage + 1)" :disabled="sitesPage >= sitesTotalPages()"
                                    class="px-3 py-1 border border-gray-200 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                Next
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Website Settings Page -->
                <div x-show="tab === 'site-settings'">
                    <div class="mb-6 flex items-start justify-between gap-4">
                        <div>
                            <h2 class="text-lg font-semibold text-gray-800">Website Settings</h2>
                            <p class="text-sm text-gray-500" x-text="managingSite ? managingSite.domain : 'Select a website from Sites to configure settings.'"></p>
                        </div>
                        <button @click="navigate('sites')"
                                class="inline-flex items-center px-3 py-2 border border-gray-200 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                            Back to Sites
                        </button>
                    </div>

                    <div x-show="!managingSite" class="bg-white rounded-xl border border-gray-100 p-8 text-center text-gray-500">
                        Open a website from the Sites table to view and edit its settings.
                    </div>

                    <div x-show="managingSite" class="space-y-6">
                        <div class="bg-white rounded-xl border border-gray-100 p-2 inline-flex gap-2">
                            <button @click="siteSettingsTab = 'general'"
                                    :class="siteSettingsTab === 'general' ? 'bg-primary-500 text-white' : 'text-gray-600 hover:bg-gray-100'"
                                    class="px-3 py-1.5 rounded-lg text-sm font-medium transition-colors">
                                General
                            </button>
                            <button @click="siteSettingsTab = 'php'"
                                    :class="siteSettingsTab === 'php' ? 'bg-primary-500 text-white' : 'text-gray-600 hover:bg-gray-100'"
                                    class="px-3 py-1.5 rounded-lg text-sm font-medium transition-colors">
                                PHP
                            </button>
                            <button @click="siteSettingsTab = 'performance'"
                                    :class="siteSettingsTab === 'performance' ? 'bg-primary-500 text-white' : 'text-gray-600 hover:bg-gray-100'"
                                    class="px-3 py-1.5 rounded-lg text-sm font-medium transition-colors">
                                Performance
                            </button>
                            <button @click="siteSettingsTab = 'domains'"
                                    :class="siteSettingsTab === 'domains' ? 'bg-primary-500 text-white' : 'text-gray-600 hover:bg-gray-100'"
                                    class="px-3 py-1.5 rounded-lg text-sm font-medium transition-colors">
                                Domains
                            </button>
                        </div>

                        <div x-show="siteSettingsTab === 'general'" class="bg-white rounded-xl p-5 border border-gray-100 space-y-5">
                            <label class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-100">
                                <div>
                                    <p class="text-sm font-medium text-gray-800">Force HTTPS Redirect</p>
                                    <p class="text-xs text-gray-500">When enabled, all HTTP traffic redirects to HTTPS automatically.</p>
                                </div>
                                <input type="checkbox" x-model="siteSettingsForm.force_https" class="rounded border-gray-300 text-primary-500">
                            </label>

                            <div class="p-3 rounded-lg border"
                                 :class="managingSite?.ssl_valid ? 'bg-green-50 border-green-200 text-green-700' : 'bg-amber-50 border-amber-200 text-amber-700'">
                                <p class="text-sm font-medium" x-text="managingSite?.ssl_valid ? 'SSL Status: Valid' : 'SSL Status: Not Ready'"></p>
                                <p class="text-xs mt-1" x-text="managingSite?.ssl_reason || 'No additional SSL details available yet.'"></p>
                            </div>
                        </div>

                        <div x-show="siteSettingsTab === 'php'" class="bg-white rounded-xl p-5 border border-gray-100 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">PHP Version</label>
                                <select x-model="siteSettingsForm.php_version" class="w-full max-w-sm px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-primary-500">
                                    <template x-for="version in getAvailablePHPVersions()" :key="'site-settings-php-' + version">
                                        <option :value="version" x-text="version"></option>
                                    </template>
                                </select>
                                <p class="text-xs text-gray-500 mt-2">Change runtime and common PHP limits for this website only.</p>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Memory Limit</label>
                                    <input type="text" x-model="siteSettingsForm.php_memory_limit" placeholder="256M"
                                           class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-primary-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Post Max Size</label>
                                    <input type="text" x-model="siteSettingsForm.php_post_max_size" placeholder="64M"
                                           class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-primary-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Upload Max Filesize</label>
                                    <input type="text" x-model="siteSettingsForm.php_upload_max_filesize" placeholder="64M"
                                           class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-primary-500">
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Max Execution Time (seconds)</label>
                                    <input type="number" min="1" max="3600" x-model.number="siteSettingsForm.php_max_execution_time"
                                           class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-primary-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Max Input Vars</label>
                                    <input type="number" min="100" max="100000" x-model.number="siteSettingsForm.php_max_input_vars"
                                           class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-primary-500">
                                </div>
                            </div>
                        </div>

                        <div x-show="siteSettingsTab === 'performance'" class="bg-white rounded-xl p-5 border border-gray-100 space-y-4">
                            <label class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-100">
                                <div>
                                    <p class="text-sm font-medium text-gray-800">Enable Compression</p>
                                    <p class="text-xs text-gray-500">Serves compressed responses for faster page loads.</p>
                                </div>
                                <input type="checkbox" x-model="siteSettingsForm.compression_enabled" @change="onCompressionToggleChanged()" class="rounded border-gray-300 text-primary-500">
                            </label>

                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                <label class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-100">
                                    <div>
                                        <p class="text-sm font-medium text-gray-800">Gzip</p>
                                        <p class="text-xs text-gray-500">Wide browser compatibility.</p>
                                    </div>
                                    <input type="checkbox" x-model="siteSettingsForm.gzip_enabled" :disabled="!siteSettingsForm.compression_enabled" class="rounded border-gray-300 text-primary-500 disabled:opacity-50">
                                </label>
                                <label class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-100">
                                    <div>
                                        <p class="text-sm font-medium text-gray-800">Zstd</p>
                                        <p class="text-xs text-gray-500">Higher compression efficiency.</p>
                                    </div>
                                    <input type="checkbox" x-model="siteSettingsForm.zstd_enabled" :disabled="!siteSettingsForm.compression_enabled" class="rounded border-gray-300 text-primary-500 disabled:opacity-50">
                                </label>
                            </div>

                            <label class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-100">
                                <div>
                                    <p class="text-sm font-medium text-gray-800">Enable Cache-Control Header</p>
                                    <p class="text-xs text-gray-500">Adds a Cache-Control response header for this site.</p>
                                </div>
                                <input type="checkbox" x-model="siteSettingsForm.cache_control_enabled" class="rounded border-gray-300 text-primary-500">
                            </label>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cache-Control Value</label>
                                <input type="text" x-model="siteSettingsForm.cache_control_value" :disabled="!siteSettingsForm.cache_control_enabled"
                                       class="w-full max-w-xl px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-primary-500 disabled:bg-gray-100 disabled:text-gray-500"
                                       placeholder="public, max-age=3600">
                            </div>
                        </div>

                        <div x-show="siteSettingsTab === 'domains'" class="bg-white rounded-xl p-5 border border-gray-100">
                            <form @submit.prevent="addDomain" class="mb-6">
                                <div class="flex space-x-2">
                                    <input type="text" x-model="newDomain.domain" required
                                           class="flex-1 px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-primary-500 focus:ring-1 focus:ring-primary-500"
                                           placeholder="Enter domain (e.g., www.example.com)">
                                    <button type="submit" :disabled="domainLoading"
                                            class="px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 disabled:opacity-50">
                                        Add
                                    </button>
                                </div>
                                <label class="flex items-center mt-2 text-sm text-gray-600">
                                    <input type="checkbox" x-model="newDomain.redirect_to_primary" class="rounded border-gray-300 text-primary-500 mr-2">
                                    Redirect to primary domain
                                </label>
                            </form>

                            <div class="space-y-2">
                                <template x-for="domain in managingSite?.domains || []" :key="domain.id">
                                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-100">
                                        <div class="flex items-center space-x-3">
                                            <span x-show="domain.is_primary" class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-primary-100 text-primary-700">
                                                Primary
                                            </span>
                                            <span x-show="domain.redirect_to_primary && !domain.is_primary" class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-700">
                                                Redirects
                                            </span>
                                            <a :href="(siteSettingsForm.force_https ? 'https://' : 'http://') + domain.domain" target="_blank" class="text-gray-800 hover:text-primary-600" x-text="domain.domain"></a>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <button x-show="!domain.is_primary && !domain.redirect_to_primary"
                                                    @click="toggleRedirect(domain, true)"
                                                    class="text-xs text-gray-500 hover:text-amber-600" title="Enable redirect">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                                                </svg>
                                            </button>
                                            <button x-show="!domain.is_primary && domain.redirect_to_primary"
                                                    @click="toggleRedirect(domain, false)"
                                                    class="text-xs text-amber-500 hover:text-gray-600" title="Disable redirect">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                </svg>
                                            </button>
                                            <button x-show="!domain.is_primary"
                                                    @click="setPrimaryDomain(domain)"
                                                    class="text-xs text-gray-500 hover:text-primary-600" title="Set as primary">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                                                </svg>
                                            </button>
                                            <button x-show="!domain.is_primary"
                                                    @click="deleteDomain(domain)"
                                                    class="text-xs text-red-500 hover:text-red-700" title="Delete domain">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                </template>
                                <div x-show="!managingSite?.domains || managingSite.domains.length === 0" class="text-center py-8 text-gray-400">
                                    No domains configured
                                </div>
                            </div>
                        </div>

                        <div x-show="siteSettingsError || domainError" class="p-3 bg-red-50 border border-red-200 rounded-lg text-red-600 text-sm">
                            <span x-text="siteSettingsError || domainError"></span>
                        </div>
                        <div x-show="siteSettingsSuccess" class="p-3 bg-green-50 border border-green-200 rounded-lg text-green-700 text-sm" x-text="siteSettingsSuccess"></div>

                        <div class="flex justify-end">
                            <button @click="saveSiteSettings" :disabled="savingSiteSettings"
                                    class="px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 font-medium disabled:opacity-50">
                                <span x-show="!savingSiteSettings">Save Settings</span>
                                <span x-show="savingSiteSettings">Saving...</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Databases Tab -->
                <div x-show="tab === 'databases'">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                        <div class="flex items-center gap-4">
                            <div class="relative">
                                <input type="text" x-model="databasesSearch" @input.debounce.300ms="searchDatabases()" 
                                       placeholder="Search databases..." 
                                       class="pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-primary-500 w-64">
                                <svg class="w-5 h-5 text-gray-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                            <span class="text-sm text-gray-500" x-text="databasesTotal + ' database' + (databasesTotal !== 1 ? 's' : '')"></span>
                        </div>
                        <button @click="showCreateDatabase = true"
                                class="inline-flex items-center px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Create Database
                        </button>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Database</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">User</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Created</th>
                                    <th class="px-6 py-4 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                <template x-for="db in databases" :key="db.id">
                                    <tr class="hover:bg-gray-50 transition-colors">
                                        <td class="px-6 py-4 font-mono text-sm" x-text="db.db_name"></td>
                                        <td class="px-6 py-4 font-mono text-sm text-gray-500" x-text="db.db_user"></td>
                                        <td class="px-6 py-4 text-sm text-gray-500" x-text="formatDate(db.created_at)"></td>
                                        <td class="px-6 py-4 text-right">
                                            <div class="inline-flex items-center gap-2">
                                                <button @click="openInPhpMyAdmin(db)"
                                                        class="inline-flex items-center justify-center w-9 h-9 rounded-lg border border-amber-200 text-amber-600 hover:bg-amber-50 hover:border-amber-300 transition-colors"
                                                        title="Open in phpMyAdmin" aria-label="Open in phpMyAdmin">
                                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7c0-1.657 3.582-3 8-3s8 1.343 8 3-3.582 3-8 3-8-1.343-8-3zm0 5c0 1.657 3.582 3 8 3s8-1.343 8-3m-16 5c0 1.657 3.582 3 8 3s8-1.343 8-3"></path>
                                                    </svg>
                                                </button>
                                                <button @click="resetDatabasePassword(db)"
                                                        class="inline-flex items-center justify-center w-9 h-9 rounded-lg border border-blue-200 text-blue-600 hover:bg-blue-50 hover:border-blue-300 transition-colors"
                                                        title="Reset database password" aria-label="Reset database password">
                                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V8a4 4 0 10-8 0v3m-2 0h12a2 2 0 012 2v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5a2 2 0 012-2zm6 4v2"></path>
                                                    </svg>
                                                </button>
                                                <button @click="deleteDatabase(db)"
                                                        :disabled="deletingDatabaseId === db.id"
                                                        class="inline-flex items-center justify-center w-9 h-9 rounded-lg border border-red-200 text-red-600 hover:bg-red-50 hover:border-red-300 transition-colors"
                                                        :class="deletingDatabaseId === db.id ? 'opacity-50 cursor-not-allowed' : ''"
                                                        title="Delete database" aria-label="Delete database">
                                                    <svg x-show="deletingDatabaseId === db.id" class="animate-spin w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                    </svg>
                                                    <svg x-show="deletingDatabaseId !== db.id" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M9 7h6m-5-3h4a1 1 0 011 1v2H9V5a1 1 0 011-1z"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </template>
                                <tr x-show="databases.length === 0">
                                    <td colspan="4" class="px-6 py-16 text-center">
                                        <div class="flex flex-col items-center">
                                            <svg class="w-12 h-12 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                                            </svg>
                                            <p class="text-gray-500 mb-2">No databases yet</p>
                                            <button @click="showCreateDatabase = true" class="text-primary-600 hover:text-primary-700 text-sm font-medium">Create your first database</button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Databases Pagination -->
                    <div x-show="databasesTotal > databasesLimit" class="flex items-center justify-between mt-4 px-2">
                        <div class="text-sm text-gray-500">
                            Showing <span x-text="((databasesPage - 1) * databasesLimit) + 1"></span> to <span x-text="Math.min(databasesPage * databasesLimit, databasesTotal)"></span> of <span x-text="databasesTotal"></span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button @click="goToDatabasesPage(databasesPage - 1)" :disabled="databasesPage <= 1"
                                    class="px-3 py-1 border border-gray-200 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                Previous
                            </button>
                            <span class="text-sm text-gray-600">Page <span x-text="databasesPage"></span> of <span x-text="databasesTotalPages()"></span></span>
                            <button @click="goToDatabasesPage(databasesPage + 1)" :disabled="databasesPage >= databasesTotalPages()"
                                    class="px-3 py-1 border border-gray-200 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                Next
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Backups Tab -->
                <div x-show="tab === 'backups'">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">Backups</h3>
                            <p class="text-sm text-gray-500">Manage backups with fast restore by snapshot date and optional resource filters.</p>
                        </div>
                        <button @click="runBackupNow()" :disabled="backupRunningNow"
                                class="inline-flex items-center px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 disabled:opacity-50">
                            <span x-text="backupRunningNow ? 'Starting...' : 'Run Backup Now'"></span>
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-5">
                        <div class="bg-white border border-gray-100 rounded-xl p-4">
                            <p class="text-xs uppercase tracking-wide text-gray-500 mb-1">Last Status</p>
                            <p class="text-sm font-medium text-gray-800" x-text="backupConfig?.last_status || 'idle'"></p>
                        </div>
                        <div class="bg-white border border-gray-100 rounded-xl p-4">
                            <p class="text-xs uppercase tracking-wide text-gray-500 mb-1">Last Run</p>
                            <p class="text-sm font-medium text-gray-800" x-text="backupConfig?.last_run_at ? formatDate(backupConfig.last_run_at) : 'Not run yet'"></p>
                        </div>
                        <div class="bg-white border border-gray-100 rounded-xl p-4">
                            <p class="text-xs uppercase tracking-wide text-gray-500 mb-1">Next Run</p>
                            <p class="text-sm font-medium text-gray-800" x-text="backupConfig?.next_run_at ? formatDate(backupConfig.next_run_at) : 'Not scheduled'"></p>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-2 mb-6">
                        <div class="flex flex-wrap gap-2">
                            <button @click="backupViewTab = 'snapshots'"
                                    class="px-3 py-2 rounded-lg text-sm font-medium transition-colors"
                                    :class="backupViewTab === 'snapshots' ? 'bg-primary-50 text-primary-700' : 'text-gray-600 hover:bg-gray-50'">
                                Snapshots & Restore
                            </button>
                            <button @click="backupViewTab = 'settings'"
                                    class="px-3 py-2 rounded-lg text-sm font-medium transition-colors"
                                    :class="backupViewTab === 'settings' ? 'bg-primary-50 text-primary-700' : 'text-gray-600 hover:bg-gray-50'">
                                Settings
                            </button>
                            <button @click="backupViewTab = 'jobs'"
                                    class="px-3 py-2 rounded-lg text-sm font-medium transition-colors"
                                    :class="backupViewTab === 'jobs' ? 'bg-primary-50 text-primary-700' : 'text-gray-600 hover:bg-gray-50'">
                                Jobs
                            </button>
                        </div>
                    </div>

                    <div x-show="backupError" class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-600" x-text="backupError"></div>
                    <div x-show="backupSuccess" class="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg text-sm text-green-700" x-text="backupSuccess"></div>

                    <div x-show="backupViewTab === 'snapshots'" class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                        <div class="flex flex-wrap items-end gap-3 mb-4">
                            <div class="min-w-[150px]">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Backup Type</label>
                                <select x-model="backupRestoreFilterType" class="w-full px-3 py-1.5 text-sm border border-gray-200 rounded-lg">
                                    <option value="all">All</option>
                                    <option value="site">Websites</option>
                                    <option value="database">Databases</option>
                                </select>
                            </div>
                            <div x-show="backupRestoreFilterType === 'site'" class="min-w-[180px]">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Website</label>
                                <select x-model="backupRestoreFilterSiteID" class="w-full px-3 py-1.5 text-sm border border-gray-200 rounded-lg">
                                    <option value="">All websites</option>
                                    <template x-for="s in (backupConfig?.catalog?.sites || [])" :key="'fsite-'+s.id">
                                        <option :value="s.id" x-text="s.domain"></option>
                                    </template>
                                </select>
                            </div>
                            <div x-show="backupRestoreFilterType === 'database'" class="min-w-[180px]">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Database</label>
                                <select x-model="backupRestoreFilterDatabaseID" class="w-full px-3 py-1.5 text-sm border border-gray-200 rounded-lg">
                                    <option value="">All databases</option>
                                    <template x-for="d in (backupConfig?.catalog?.databases || [])" :key="'fdb-'+d.id">
                                        <option :value="d.id" x-text="d.db_name"></option>
                                    </template>
                                </select>
                            </div>
                            <div class="ml-auto text-xs text-gray-400" x-text="`${filteredBackupSnapshotsTable().length} snapshot(s)`"></div>
                        </div>

                        <div class="space-y-0 border border-gray-200 rounded-lg overflow-hidden">
                            <template x-for="snap in filteredBackupSnapshotsTable()" :key="snap.id">
                                <div class="border-b border-gray-100 last:border-b-0">
                                    <div @click="expandedSnapshotId = expandedSnapshotId === snap.id ? '' : snap.id"
                                         class="flex items-center gap-3 px-4 py-3 cursor-pointer hover:bg-gray-50 transition-colors select-none"
                                         :class="expandedSnapshotId === snap.id ? 'bg-gray-50' : ''">
                                        <svg class="w-4 h-4 text-gray-400 shrink-0 transition-transform duration-200"
                                             :class="expandedSnapshotId === snap.id ? 'rotate-90' : ''"
                                             fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                        </svg>
                                        <div class="flex-1 min-w-0 flex flex-wrap items-center gap-x-4 gap-y-1">
                                            <span class="text-sm text-gray-800 whitespace-nowrap" x-text="formatDateTime(snap.time)"></span>
                                            <span class="text-xs font-mono text-gray-500" x-text="(snap.short_id || snap.id || '').slice(0, 10)"></span>
                                            <span class="inline-flex px-2 py-0.5 text-[11px] rounded-full"
                                                  :class="snapshotTypeBadgeClass(snap)"
                                                  x-text="snapshotTypeLabel(snap)"></span>
                                            <span class="text-xs text-gray-500" x-text="snapshotSizeLabel(snap)"></span>
                                            <span class="text-xs text-gray-500" x-text="snapshotContentsSummary(snap)"></span>
                                        </div>
                                        <div class="flex items-center gap-1.5 shrink-0" @click.stop>
                                            <button @click="if(confirm('Download this snapshot as a ZIP file? This may take a while for large backups.')) downloadSelectedBackupSnapshot(snap.id)"
                                                    :disabled="backupSnapshotDownloading"
                                                    class="p-1.5 text-gray-400 hover:text-gray-700 hover:bg-gray-100 rounded-md disabled:opacity-40"
                                                    title="Download ZIP">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                                            </button>
                                            <button @click="deleteSelectedBackupSnapshot(snap.id)"
                                                    :disabled="backupSnapshotDeleting"
                                                    class="p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-md disabled:opacity-40"
                                                    title="Delete snapshot">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                            </button>
                                        </div>
                                    </div>

                                    <div x-show="expandedSnapshotId === snap.id"
                                         x-transition:enter="transition ease-out duration-200"
                                         x-transition:enter-start="opacity-0 -translate-y-1"
                                         x-transition:enter-end="opacity-100 translate-y-0"
                                         class="bg-gray-50 border-t border-gray-200">
                                        <div class="px-5 py-4 space-y-4">
                                            <div class="flex items-start gap-2 text-xs text-gray-500">
                                                <span class="font-medium text-gray-600">Full ID:</span>
                                                <span class="font-mono break-all" x-text="snap.id"></span>
                                            </div>
                                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-xs text-gray-500">
                                                <div>
                                                    <span class="font-medium text-gray-600">Date/Time:</span>
                                                    <span class="ml-1" x-text="formatDateTime(snap.time)"></span>
                                                </div>
                                                <div>
                                                    <span class="font-medium text-gray-600">Snapshot Size:</span>
                                                    <span class="ml-1" x-text="snapshotSizeLabel(snap)"></span>
                                                </div>
                                            </div>

                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div>
                                                    <h4 class="text-xs font-semibold text-gray-700 uppercase tracking-wide mb-2">
                                                        Websites
                                                        <span class="font-normal text-gray-400 normal-case"
                                                              x-text="`(${snapshotSiteDomainValues(snap).length})`"></span>
                                                    </h4>
                                                    <div x-show="snapshotSiteDomainValues(snap).length > 0" class="space-y-1.5">
                                                        <template x-for="domain in snapshotSiteDomainValues(snap)" :key="`${snap.id}-detail-site-${domain}`">
                                                            <div class="flex items-center justify-between gap-2 bg-white border border-gray-200 rounded-lg px-3 py-2">
                                                                <span class="text-sm text-gray-800 truncate" x-text="domain"></span>
                                                                <template x-if="snapshotRestoreSiteByDomain(snap, domain)">
                                                                    <button @click="if(confirm('Restore ' + domain + ' from this snapshot? This will overwrite the current site files.')) restoreSiteFromSnapshot(snapshotRestoreSiteByDomain(snap, domain).id, snap.id)"
                                                                            :disabled="restoreLoading"
                                                                            class="shrink-0 px-2.5 py-1 text-xs font-medium text-primary-600 bg-primary-50 rounded-md hover:bg-primary-100 disabled:opacity-50">
                                                                        Restore
                                                                    </button>
                                                                </template>
                                                                <template x-if="!snapshotRestoreSiteByDomain(snap, domain)">
                                                                    <span class="text-[11px] text-gray-400 shrink-0">Not on server</span>
                                                                </template>
                                                            </div>
                                                        </template>
                                                    </div>
                                                    <p x-show="snapshotSiteDomainValues(snap).length === 0" class="text-xs text-gray-400">No websites in this snapshot.</p>
                                                </div>

                                                <div>
                                                    <h4 class="text-xs font-semibold text-gray-700 uppercase tracking-wide mb-2">
                                                        Databases
                                                        <span class="font-normal text-gray-400 normal-case"
                                                              x-text="`(${snapshotDatabaseNameValues(snap).length})`"></span>
                                                    </h4>
                                                    <div x-show="snapshotDatabaseNameValues(snap).length > 0" class="space-y-1.5">
                                                        <template x-for="dbName in snapshotDatabaseNameValues(snap)" :key="`${snap.id}-detail-db-${dbName}`">
                                                            <div class="flex items-center justify-between gap-2 bg-white border border-gray-200 rounded-lg px-3 py-2">
                                                                <span class="text-sm text-gray-800 font-mono truncate" x-text="dbName"></span>
                                                                <template x-if="snapshotRestoreDBByName(snap, dbName)">
                                                                    <button @click="if(confirm('Restore database \'' + dbName + '\' from this snapshot? This will overwrite the current database.')) restoreDatabaseFromSnapshot(snapshotRestoreDBByName(snap, dbName).id, snap.id)"
                                                                            :disabled="restoreLoading"
                                                                            class="shrink-0 px-2.5 py-1 text-xs font-medium text-emerald-600 bg-emerald-50 rounded-md hover:bg-emerald-100 disabled:opacity-50">
                                                                        Restore
                                                                    </button>
                                                                </template>
                                                                <template x-if="!snapshotRestoreDBByName(snap, dbName)">
                                                                    <span class="text-[11px] text-gray-400 shrink-0">Not on server</span>
                                                                </template>
                                                            </div>
                                                        </template>
                                                    </div>
                                                    <p x-show="snapshotDatabaseNameValues(snap).length === 0" class="text-xs text-gray-400">No databases in this snapshot.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                            <div x-show="filteredBackupSnapshotsTable().length === 0" class="px-4 py-10 text-center text-sm text-gray-400">
                                No snapshots match current filters.
                            </div>
                        </div>
                    </div>

                    <div x-show="backupViewTab === 'settings'" class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Backup Backend</label>
                                <select x-model="backupForm.backend_type" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-primary-500">
                                    <option value="sftp">SFTP</option>
                                    <option value="s3">S3 (S3-compatible)</option>
                                    <option value="local">Local Disk</option>
                                    <option value="rclone">Rclone (Advanced)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Repository</label>
                                <input type="text" :value="backupRepositoryPreview() || backupForm.repository"
                                       placeholder="Auto-generated from backend fields"
                                       readonly
                                       class="w-full px-3 py-2 border border-gray-200 bg-gray-50 rounded-lg text-gray-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Repository Password</label>
                                <input type="password" x-model="backupForm.repository_password"
                                       :placeholder="backupConfig?.has_password ? 'Leave empty to keep existing password' : 'Set repository password'"
                                       class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-primary-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Schedule (Cron)</label>
                                <input type="text" x-model="backupForm.schedule_cron" placeholder="0 2 * * *"
                                       class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-primary-500">
                                <div class="mt-2 flex flex-wrap gap-2">
                                    <button type="button"
                                            @click="setBackupSchedulePreset('0 * * * *')"
                                            :class="isBackupSchedulePreset('0 * * * *') ? 'bg-primary-50 text-primary-700 border-primary-200' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'"
                                            class="px-2.5 py-1 text-xs border rounded-md transition-colors">
                                        Hourly
                                    </button>
                                    <button type="button"
                                            @click="setBackupSchedulePreset('0 */6 * * *')"
                                            :class="isBackupSchedulePreset('0 */6 * * *') ? 'bg-primary-50 text-primary-700 border-primary-200' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'"
                                            class="px-2.5 py-1 text-xs border rounded-md transition-colors">
                                        Every 6 Hours
                                    </button>
                                    <button type="button"
                                            @click="setBackupSchedulePreset('0 2 * * *')"
                                            :class="isBackupSchedulePreset('0 2 * * *') ? 'bg-primary-50 text-primary-700 border-primary-200' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'"
                                            class="px-2.5 py-1 text-xs border rounded-md transition-colors">
                                        Daily
                                    </button>
                                    <button type="button"
                                            @click="setBackupSchedulePreset('0 2 * * 0')"
                                            :class="isBackupSchedulePreset('0 2 * * 0') ? 'bg-primary-50 text-primary-700 border-primary-200' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'"
                                            class="px-2.5 py-1 text-xs border rounded-md transition-colors">
                                        Weekly
                                    </button>
                                </div>
                                <p class="mt-1 text-xs text-gray-400">Quick presets. You can still enter any custom cron expression.</p>
                            </div>
                            <div class="flex items-end">
                                <label class="inline-flex items-center gap-2 text-sm text-gray-700">
                                    <input type="checkbox" x-model="backupForm.enabled" class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                                    Enable automatic backups
                                </label>
                            </div>
                        </div>

                        <div class="mt-4 border border-gray-100 rounded-lg p-4 space-y-3">
                            <div x-show="backupForm.backend_type === 'sftp'" class="grid grid-cols-1 md:grid-cols-4 gap-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">SFTP Username</label>
                                    <input type="text" x-model="backupForm.sftp_username" placeholder="backupuser"
                                           class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">SFTP Host</label>
                                    <input type="text" x-model="backupForm.sftp_host" placeholder="backup.example.com"
                                           class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">SFTP Port</label>
                                    <input type="number" min="1" max="65535" x-model.number="backupForm.sftp_port" placeholder="22"
                                           class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Remote Path</label>
                                    <input type="text" x-model="backupForm.sftp_path" placeholder="/home/backup/fastcp"
                                           class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                                </div>
                            </div>

                            <div x-show="backupForm.backend_type === 's3'" class="space-y-3">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-600 mb-1">S3 Endpoint</label>
                                        <input type="text" x-model="backupForm.s3_endpoint" placeholder="https://s3.us-east-1.amazonaws.com"
                                               class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-600 mb-1">Bucket</label>
                                        <input type="text" x-model="backupForm.s3_bucket" placeholder="my-fastcp-backups"
                                               class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-600 mb-1">Prefix (Optional)</label>
                                        <input type="text" x-model="backupForm.s3_prefix" placeholder="users/john"
                                               class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">AWS Access Key ID</label>
                                    <input type="text" x-model="backupForm.s3_access_key_id"
                                           :placeholder="backupConfig?.has_s3_credentials ? 'Leave empty to keep existing key' : 'AKIA...'"
                                           class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">AWS Secret Access Key</label>
                                    <input type="password" x-model="backupForm.s3_secret_access_key"
                                           :placeholder="backupConfig?.has_s3_credentials ? 'Leave empty to keep existing secret' : 'Set secret access key'"
                                           class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">AWS Session Token (Optional)</label>
                                    <input type="password" x-model="backupForm.s3_session_token"
                                           :placeholder="backupConfig?.has_s3_session_token ? 'Leave empty to keep existing token' : 'Optional temporary credential token'"
                                           class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-600 mb-1">S3 Region (Optional)</label>
                                        <input type="text" x-model="backupForm.s3_region" placeholder="us-east-1"
                                               class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-600 mb-1">Bucket Lookup Mode</label>
                                        <select x-model="backupForm.s3_bucket_lookup" class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                                            <option value="auto">auto</option>
                                            <option value="dns">dns (virtual-hosted)</option>
                                            <option value="path">path-style</option>
                                        </select>
                                    </div>
                                    <div class="flex items-end">
                                        <label class="inline-flex items-center gap-2 text-xs text-gray-700">
                                            <input type="checkbox" x-model="backupForm.s3_list_objects_v1" class="rounded border-gray-300 text-primary-600">
                                            Use legacy `ListObjects` v1
                                        </label>
                                    </div>
                                </div>
                                <div class="text-[11px] text-gray-500">
                                    Restic uses `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, optional `AWS_SESSION_TOKEN`, and supports `s3.region`, `s3.bucket-lookup`, and `s3.list-objects-v1`.
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">S3 Repository Preview</label>
                                    <input type="text" :value="backupRepositoryPreview()" readonly
                                           class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                                </div>
                            </div>

                            <div x-show="backupForm.backend_type === 'local'" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Local Backup Path</label>
                                    <input type="text" x-model="backupForm.local_path" placeholder="/var/backups/fastcp"
                                           class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                                </div>
                            </div>

                            <div x-show="backupForm.backend_type === 'rclone'" class="space-y-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Rclone Repository</label>
                                    <input type="text" x-model="backupForm.rclone_repository" placeholder="rclone:remote:bucket/path"
                                           class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                                </div>
                                <div class="rounded-lg border p-3"
                                     :class="backupRcloneStatus?.status === 'available' ? 'bg-green-50 border-green-200' : (backupRcloneStatus?.status === 'installing' ? 'bg-amber-50 border-amber-200' : (backupRcloneStatus?.status === 'failed' ? 'bg-red-50 border-red-200' : 'bg-gray-50 border-gray-200'))">
                                    <div class="flex flex-wrap items-center gap-2">
                                        <span class="text-xs font-medium text-gray-700">Rclone Status:</span>
                                        <span class="inline-flex px-2 py-0.5 text-xs rounded-full"
                                              :class="backupRcloneStatus?.status === 'available' ? 'bg-green-100 text-green-700' : (backupRcloneStatus?.status === 'installing' ? 'bg-amber-100 text-amber-700' : (backupRcloneStatus?.status === 'failed' ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-700'))"
                                              x-text="(backupRcloneStatus?.status || 'missing')"></span>
                                        <span x-show="backupRcloneStatus?.version" class="text-xs text-gray-500" x-text="backupRcloneStatus?.version"></span>
                                        <button x-show="(backupRcloneStatus?.status || 'missing') !== 'available'"
                                                @click="installBackupRclone()"
                                                :disabled="backupRcloneInstalling || backupRcloneStatus?.status === 'installing'"
                                                class="ml-auto px-3 py-1.5 text-xs border border-gray-200 rounded-lg hover:bg-gray-50 disabled:opacity-50">
                                            <span x-text="backupRcloneInstalling || backupRcloneStatus?.status === 'installing' ? 'Installing...' : 'Install rclone'"></span>
                                        </button>
                                    </div>
                                    <p class="text-xs text-gray-600 mt-2" x-text="backupRcloneStatus?.message || 'rclone is required for rclone: repositories.'"></p>
                                </div>
                                <div class="rounded-lg bg-blue-50 border border-blue-200 p-3">
                                    <p class="text-xs font-semibold text-blue-800 mb-2">Rclone setup (SSH terminal required)</p>
                                    <p class="text-[11px] text-blue-700 mb-2">
                                        Configure rclone backends from SSH first, then use the created remote in the repository field here.
                                    </p>
                                    <ol class="text-[11px] text-blue-700 space-y-1 list-decimal pl-4">
                                        <li>SSH into the server and configure rclone as this Linux user.</li>
                                        <li>If you are already logged in as this user, run:</li>
                                    </ol>
                                    <div class="mt-2 rounded-md bg-white border border-blue-100 p-2 space-y-1">
                                        <p class="text-[11px] font-mono text-gray-700">rclone config</p>
                                        <p class="text-[11px] font-mono text-gray-700">rclone listremotes</p>
                                    </div>
                                    <p class="text-[11px] text-blue-700 mt-2">If you are logged in as root/admin, run:</p>
                                    <div class="mt-2 rounded-md bg-white border border-blue-100 p-2 space-y-1">
                                        <p class="text-[11px] font-mono text-gray-700" x-text="`sudo -u ${user?.username || 'username'} rclone config`"></p>
                                        <p class="text-[11px] font-mono text-gray-700" x-text="`sudo -u ${user?.username || 'username'} rclone listremotes`"></p>
                                    </div>
                                    <p class="text-[11px] text-blue-700 mt-2">
                                        Repository format: <span class="font-mono">rclone:&lt;remote&gt;:&lt;bucket-or-path&gt;</span>
                                    </p>
                                    <p class="text-[11px] text-blue-700 mt-1">
                                        Example: <span class="font-mono">rclone:myremote:fastcp-backups/user-data</span>
                                    </p>
                                </div>
                            </div>

                            <div class="rounded-lg bg-gray-50 border border-gray-100 p-3">
                                <p class="text-xs uppercase tracking-wide text-gray-500 mb-1">Repository Preview</p>
                                <p class="text-xs font-mono text-gray-700 break-all" x-text="backupRepositoryPreview() || 'Complete backend fields to generate repository value.'"></p>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-4">
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Keep Last</label>
                                <input type="number" min="0" x-model.number="backupForm.keep_last" class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Keep Daily</label>
                                <input type="number" min="0" x-model.number="backupForm.keep_daily" class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Keep Weekly</label>
                                <input type="number" min="0" x-model.number="backupForm.keep_weekly" class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Keep Monthly</label>
                                <input type="number" min="0" x-model.number="backupForm.keep_monthly" class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-5">
                            <div class="border border-gray-100 rounded-lg p-3">
                                <p class="text-sm font-medium text-gray-700 mb-2">Exclude Websites</p>
                                <div class="max-h-40 overflow-y-auto space-y-1">
                                    <template x-for="s in (backupConfig?.catalog?.sites || [])" :key="s.id">
                                        <label class="flex items-center gap-2 text-sm text-gray-600">
                                            <input type="checkbox" :value="s.id" x-model="backupForm.exclude_site_ids" class="rounded border-gray-300 text-primary-600">
                                            <span x-text="s.domain"></span>
                                        </label>
                                    </template>
                                    <p x-show="(backupConfig?.catalog?.sites || []).length === 0" class="text-xs text-gray-400">No websites available.</p>
                                </div>
                            </div>
                            <div class="border border-gray-100 rounded-lg p-3">
                                <p class="text-sm font-medium text-gray-700 mb-2">Exclude Databases</p>
                                <div class="max-h-40 overflow-y-auto space-y-1">
                                    <template x-for="d in (backupConfig?.catalog?.databases || [])" :key="d.id">
                                        <label class="flex items-center gap-2 text-sm text-gray-600">
                                            <input type="checkbox" :value="d.id" x-model="backupForm.exclude_database_ids" class="rounded border-gray-300 text-primary-600">
                                            <span x-text="d.db_name"></span>
                                        </label>
                                    </template>
                                    <p x-show="(backupConfig?.catalog?.databases || []).length === 0" class="text-xs text-gray-400">No databases available.</p>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4 flex justify-end gap-2">
                            <button @click="testBackupConfig()" :disabled="backupTesting"
                                    class="px-4 py-2 border border-gray-200 text-gray-700 rounded-lg hover:bg-gray-50 disabled:opacity-50">
                                <span x-text="backupTesting ? 'Testing...' : 'Test Connection'"></span>
                            </button>
                            <button @click="saveBackupConfig()" :disabled="backupSaving || backupTesting"
                                    class="px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 disabled:opacity-50">
                                <span x-text="backupSaving ? 'Saving...' : 'Save Backup Settings'"></span>
                            </button>
                        </div>
                    </div>

                    <div x-show="backupViewTab === 'jobs'" class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                        <h4 class="text-base font-semibold text-gray-800 mb-3">Backup Jobs</h4>
                        <div class="space-y-2 max-h-[540px] overflow-y-auto">
                            <template x-for="job in backupJobs" :key="job.id">
                                <div class="border border-gray-100 rounded-lg p-3">
                                    <div class="flex items-center justify-between">
                                        <p class="text-sm font-medium text-gray-700" x-text="job.job_type"></p>
                                        <span class="text-xs px-2 py-0.5 rounded-full"
                                              :class="job.status === 'success' ? 'bg-green-100 text-green-700' : (job.status === 'failed' ? 'bg-red-100 text-red-700' : 'bg-amber-100 text-amber-700')"
                                              x-text="job.status"></span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1" x-text="formatDate(job.started_at)"></p>
                                    <p class="text-xs text-gray-600 mt-1 break-words" x-text="job.message || ''"></p>
                                </div>
                            </template>
                            <p x-show="backupJobs.length === 0" class="text-sm text-gray-400">No backup jobs yet.</p>
                        </div>
                    </div>
                </div>

                <!-- SSH & SFTP Tab -->
                <div x-show="tab === 'ssh'">
                    <div class="flex justify-between items-center mb-6">
                        <p class="text-gray-500">Manage SSH keys and connect over SSH/SFTP to your website files</p>
                        <button @click="showAddSSHKey = true"
                                class="inline-flex items-center px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Add SSH Key
                        </button>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">SSH / SFTP Connection Details</h3>
                            <button @click="showSFTPHelp = !showSFTPHelp"
                                    class="inline-flex items-center px-2.5 py-1.5 text-xs font-medium border border-gray-200 rounded-lg text-gray-600 hover:bg-gray-50"
                                    :aria-expanded="showSFTPHelp ? 'true' : 'false'"
                                    :title="showSFTPHelp ? 'Hide help instructions' : 'Show help instructions'">
                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9a3 3 0 115.544 1c0 1-1 1.5-1.8 2.1-.7.52-1.2 1.06-1.2 1.9M12 17h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span x-text="showSFTPHelp ? 'Hide Help' : 'Show Help'"></span>
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="rounded-lg border border-gray-100 bg-gray-50 p-4">
                                <p class="text-xs uppercase tracking-wide text-gray-500 mb-1">Host</p>
                                <p class="font-mono text-gray-800" x-text="sftpHost()"></p>
                            </div>
                            <div class="rounded-lg border border-gray-100 bg-gray-50 p-4">
                                <p class="text-xs uppercase tracking-wide text-gray-500 mb-1">Port</p>
                                <p class="font-mono text-gray-800" x-text="user?.is_admin ? (sshConnectionPort || 22) : 22"></p>
                            </div>
                            <div class="rounded-lg border border-gray-100 bg-gray-50 p-4">
                                <p class="text-xs uppercase tracking-wide text-gray-500 mb-1">Username</p>
                                <p class="font-mono text-gray-800" x-text="user?.username || '-'"></p>
                            </div>
                        </div>
                        <div x-show="showSFTPHelp" class="mt-4 space-y-2 text-sm text-gray-600">
                            <p>Use the same username and password you use to log in to this control panel for SSH and SFTP access.</p>
                            <p>If password authentication is disabled on your server, authenticate using SSH keys instead.</p>
                            <p>You can use an SFTP client like Cyberduck to upload website content, download files, or manage website files directly.</p>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Fingerprint</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Added</th>
                                    <th class="px-6 py-4 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                <template x-for="key in sshKeys" :key="key.id">
                                    <tr class="hover:bg-gray-50 transition-colors">
                                        <td class="px-6 py-4 font-medium" x-text="key.name"></td>
                                        <td class="px-6 py-4 font-mono text-xs text-gray-500" x-text="key.fingerprint"></td>
                                        <td class="px-6 py-4 text-sm text-gray-500" x-text="formatDate(key.created_at)"></td>
                                        <td class="px-6 py-4 text-right">
                                            <button @click="deleteSSHKey(key)" class="text-red-500 hover:text-red-700 text-sm font-medium">Remove</button>
                                        </td>
                                    </tr>
                                </template>
                                <tr x-show="sshKeys.length === 0">
                                    <td colspan="4" class="px-6 py-16 text-center">
                                        <div class="flex flex-col items-center">
                                            <svg class="w-12 h-12 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                                            </svg>
                                            <p class="text-gray-500 mb-2">No SSH keys yet</p>
                                            <button @click="showAddSSHKey = true" class="text-primary-600 hover:text-primary-700 text-sm font-medium">Add your first SSH key</button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Cron Jobs Tab -->
                <div x-show="tab === 'cron'">
                    <div class="flex justify-between items-center mb-6">
                        <p class="text-gray-500">Schedule automated tasks to run at specific times</p>
                        <button @click="showCronCreateForm = !showCronCreateForm; if (!showCronCreateForm) resetCronForm()"
                                class="inline-flex items-center px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v12m6-6H6"></path>
                            </svg>
                            <span x-text="showCronCreateForm ? 'Hide Cron Form' : 'New Cron Job'"></span>
                        </button>
                    </div>

                    <div x-show="showCronCreateForm" x-transition class="bg-white rounded-xl shadow-sm border border-gray-100 p-5 mb-6">
                        <h3 class="text-base font-semibold text-gray-800 mb-4">Create Cron Job</h3>
                        <form @submit.prevent="createCronJob()">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Name</label>
                                    <input type="text" x-model="cronForm.name" required
                                           class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-primary-500"
                                           placeholder="e.g., Database Backup">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Schedule (Cron Expression)</label>
                                    <div class="relative">
                                        <input type="text" x-model="cronForm.expression" required
                                               @input="validateCronExpression()"
                                               class="w-full px-3 py-2 border rounded-lg focus:outline-none font-mono text-sm"
                                               :class="cronValidation.valid === true ? 'border-green-300 focus:border-green-500' : cronValidation.valid === false ? 'border-red-300 focus:border-red-500' : 'border-gray-200 focus:border-primary-500'"
                                               placeholder="*/5 * * * *">
                                        <div class="absolute right-3 top-1/2 -translate-y-1/2">
                                            <svg x-show="cronValidation.valid === true" class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                            <svg x-show="cronValidation.valid === false" class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <p class="text-xs mt-2" :class="cronValidation.valid === true ? 'text-green-600' : cronValidation.valid === false ? 'text-red-600' : 'text-gray-500'"
                                       x-text="cronValidation.description || 'Format: minute hour day month weekday'"></p>
                                </div>
                            </div>

                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Quick Presets</label>
                                <div class="flex flex-wrap gap-2">
                                    <button type="button" @click="setCronPreset('*/5 * * * *')" class="px-3 py-1.5 text-xs bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">Every 5 min</button>
                                    <button type="button" @click="setCronPreset('0 * * * *')" class="px-3 py-1.5 text-xs bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">Hourly</button>
                                    <button type="button" @click="setCronPreset('0 0 * * *')" class="px-3 py-1.5 text-xs bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">Daily</button>
                                    <button type="button" @click="setCronPreset('0 0 * * 0')" class="px-3 py-1.5 text-xs bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">Weekly</button>
                                    <button type="button" @click="setCronPreset('0 0 1 * *')" class="px-3 py-1.5 text-xs bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">Monthly</button>
                                    <button type="button" @click="setCronPreset('0 3 * * *')" class="px-3 py-1.5 text-xs bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">3 AM Daily</button>
                                </div>
                            </div>

                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Command</label>
                                <textarea x-model="cronForm.command" required rows="3"
                                          class="w-full px-3 py-2 border border-gray-200 rounded-lg font-mono text-sm focus:outline-none focus:border-primary-500"
                                          placeholder="/usr/bin/php /home/user/apps/site/cron.php"></textarea>
                                <p class="text-xs text-gray-500 mt-1">Use absolute paths. Output is captured in user's cron logs.</p>
                                <div class="mt-3">
                                    <p class="text-xs font-medium text-gray-700 mb-2">PHP CLI Paths</p>
                                    <div class="flex flex-wrap gap-2">
                                        <template x-for="phpPath in cronPHPCLIPaths()" :key="'cron-create-php-' + phpPath">
                                            <button type="button"
                                                    @click="copyCronPath(phpPath)"
                                                    class="inline-flex items-center gap-2 px-2.5 py-1.5 border border-gray-200 rounded-md bg-gray-50 hover:bg-gray-100 text-xs font-mono text-gray-700">
                                                <span x-text="phpPath"></span>
                                                <span class="text-[11px] font-medium text-primary-600">Copy</span>
                                            </button>
                                        </template>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-2">Cron runs exactly the command you enter as your Linux user. Use any path above, for example: <span class="font-mono">/usr/bin/php8.4 /home/USERNAME/apps/SITE/artisan schedule:run</span></p>
                                    <p x-show="cronHelperMessage" class="text-xs text-green-600 mt-1" x-text="cronHelperMessage"></p>
                                </div>
                            </div>

                            <div x-show="cronError" class="mt-4 bg-red-50 border border-red-200 text-red-700 px-3 py-2 rounded-lg text-sm">
                                <span x-text="cronError"></span>
                            </div>

                            <div class="mt-4 flex gap-2">
                                <button type="button" @click="resetCronForm()" class="px-4 py-2 border border-gray-200 rounded-lg hover:bg-gray-50 font-medium text-sm">Clear</button>
                                <button type="submit" :disabled="cronValidation.valid === false"
                                        class="px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 font-medium text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                                    Create Cron Job
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Schedule</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Command</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-4 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                <template x-for="job in cronJobs" :key="job.id">
                                    <tr class="hover:bg-gray-50 transition-colors">
                                        <td class="px-6 py-4">
                                            <div class="font-medium text-gray-900" x-text="job.name"></div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="text-sm text-gray-900" x-text="job.description"></div>
                                            <div class="text-xs text-gray-400 font-mono mt-1" x-text="job.expression"></div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <code class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded font-mono max-w-xs truncate block" x-text="job.command"></code>
                                        </td>
                                        <td class="px-6 py-4">
                                            <button @click="toggleCronJob(job)" 
                                                    :class="job.enabled ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'"
                                                    class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium transition-colors hover:opacity-80">
                                                <span class="w-2 h-2 rounded-full mr-1.5" :class="job.enabled ? 'bg-green-500' : 'bg-gray-400'"></span>
                                                <span x-text="job.enabled ? 'Active' : 'Paused'"></span>
                                            </button>
                                        </td>
                                        <td class="px-6 py-4 text-right">
                                            <div class="inline-flex items-center gap-2">
                                                <button @click="editCronJob(job)"
                                                        class="inline-flex items-center justify-center w-9 h-9 rounded-lg border border-primary-200 text-primary-600 hover:bg-primary-50 hover:border-primary-300 transition-colors"
                                                        title="Edit cron job" aria-label="Edit cron job">
                                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5M16.5 3.5a2.121 2.121 0 113 3L12 14l-4 1 1-4 7.5-7.5z"></path>
                                                    </svg>
                                                </button>
                                                <button @click="deleteCronJob(job)"
                                                        class="inline-flex items-center justify-center w-9 h-9 rounded-lg border border-red-200 text-red-600 hover:bg-red-50 hover:border-red-300 transition-colors"
                                                        title="Delete cron job" aria-label="Delete cron job">
                                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M9 7h6m-5-3h4a1 1 0 011 1v2H9V5a1 1 0 011-1z"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </template>
                                <tr x-show="cronJobs.length === 0">
                                    <td colspan="5" class="px-6 py-16 text-center">
                                        <div class="flex flex-col items-center">
                                            <svg class="w-12 h-12 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            <p class="text-gray-500 mb-2">No cron jobs yet</p>
                                            <button @click="showCronCreateForm = true" class="text-primary-600 hover:text-primary-700 text-sm font-medium">Create your first cron job</button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                </div>

                <!-- System Tab -->
                <div x-show="tab === 'system'">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-2 mt-6">
                        <div class="flex flex-wrap gap-2">
                            <button @click="systemSettingsTab = 'php'"
                                    :class="systemSettingsTab === 'php' ? 'bg-primary-50 text-primary-700 border-primary-200' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'"
                                    class="px-3 py-1.5 text-sm rounded-lg border transition-colors">
                                Default PHP
                            </button>
                            <button @click="systemSettingsTab = 'mysql'"
                                    :class="systemSettingsTab === 'mysql' ? 'bg-primary-50 text-primary-700 border-primary-200' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'"
                                    class="px-3 py-1.5 text-sm rounded-lg border transition-colors">
                                MySQL
                            </button>
                            <button @click="systemSettingsTab = 'caddy'"
                                    :class="systemSettingsTab === 'caddy' ? 'bg-primary-50 text-primary-700 border-primary-200' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'"
                                    class="px-3 py-1.5 text-sm rounded-lg border transition-colors">
                                Caddy
                            </button>
                            <button @click="systemSettingsTab = 'ssh'"
                                    :class="systemSettingsTab === 'ssh' ? 'bg-primary-50 text-primary-700 border-primary-200' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'"
                                    class="px-3 py-1.5 text-sm rounded-lg border transition-colors">
                                SSH / SFTP
                            </button>
                            <button @click="systemSettingsTab = 'firewall'"
                                    :class="systemSettingsTab === 'firewall' ? 'bg-primary-50 text-primary-700 border-primary-200' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'"
                                    class="px-3 py-1.5 text-sm rounded-lg border transition-colors">
                                Firewall
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mt-6" x-show="systemSettingsTab === 'php' && phpDefaultConfig">
                        <h3 class="text-lg font-semibold text-gray-800 mb-1">Default PHP Version</h3>
                        <p class="text-sm text-gray-500 mb-6">Set the default PHP version pre-selected when creating new websites.</p>

                        <div x-show="phpDefaultConfigError" class="mb-4 p-3 bg-red-50 border border-red-200 text-red-700 rounded-lg text-sm" x-text="phpDefaultConfigError"></div>
                        <div x-show="phpDefaultConfigSuccess" class="mb-4 p-3 bg-green-50 border border-green-200 text-green-700 rounded-lg text-sm" x-text="phpDefaultConfigSuccess"></div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Default PHP Version</label>
                                <select x-model="phpDefaultConfig.default_php_version"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                    <template x-for="version in (phpDefaultConfig.available_php_versions || [])" :key="version">
                                        <option :value="version" x-text="'PHP ' + version"></option>
                                    </template>
                                </select>
                                <p class="text-xs text-gray-400 mt-1">Only installed PHP versions are listed.</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Install Additional PHP Version</label>
                                <div class="flex flex-wrap gap-2">
                                    <template x-for="version in ['8.2', '8.3', '8.4', '8.5']" :key="'install-php-' + version">
                                        <button @click="installPHPVersion(version)"
                                                :disabled="isPHPVersionInstalled(version) || phpVersionInstalling[version]"
                                                class="inline-flex items-center px-3 py-2 border rounded-lg text-sm transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                                :class="isPHPVersionInstalled(version) ? 'border-gray-200 text-gray-400 bg-gray-50' : 'border-primary-200 text-primary-700 hover:bg-primary-50'">
                                            <svg x-show="phpVersionInstalling[version]" class="animate-spin -ml-0.5 mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                            <span x-text="isPHPVersionInstalled(version) ? ('PHP ' + version + ' Installed') : (phpVersionInstalling[version] ? ('Installing PHP ' + version + '...') : ('Install PHP ' + version))"></span>
                                        </button>
                                    </template>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">FastCP installs PHP 8.4 by default. Install other versions only when needed.</p>
                            </div>
                        </div>

                        <div class="mt-6 flex items-center">
                            <button @click="savePHPDefaultConfig()" :disabled="phpDefaultConfigSaving"
                                    class="inline-flex items-center px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors disabled:opacity-50">
                                <svg x-show="phpDefaultConfigSaving" class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <span x-text="phpDefaultConfigSaving ? 'Saving Default PHP...' : 'Save Default PHP'"></span>
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mt-6" x-show="systemSettingsTab === 'mysql' && mysqlConfig">
                        <h3 class="text-lg font-semibold text-gray-800 mb-1">MySQL Settings</h3>
                        <p class="text-sm text-gray-500 mb-6">Adjust key performance settings. Changes will restart the MySQL service.</p>

                        <div x-show="mysqlConfigError" class="mb-4 p-3 bg-red-50 border border-red-200 text-red-700 rounded-lg text-sm" x-text="mysqlConfigError"></div>
                        <div x-show="mysqlConfigSuccess" class="mb-4 p-3 bg-green-50 border border-green-200 text-green-700 rounded-lg text-sm" x-text="mysqlConfigSuccess"></div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">InnoDB Buffer Pool Size (MB)</label>
                                <input type="number" min="16" max="16384" x-model.number="mysqlConfig.buffer_pool_mb"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                <p class="text-xs text-gray-400 mt-1" x-show="mysqlConfig?.detected_ram_mb"
                                   x-text="'Server RAM: ' + mysqlConfig.detected_ram_mb + ' MB. Recommended: ' + Math.max(64, Math.round(mysqlConfig.detected_ram_mb * 0.25)) + '-' + Math.round(mysqlConfig.detected_ram_mb * 0.5) + ' MB'"></p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Max Connections</label>
                                <input type="number" min="5" max="5000" x-model.number="mysqlConfig.max_connections"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                <p class="text-xs text-gray-400 mt-1">Typical range: 20-500</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Performance Schema</label>
                                <div class="flex items-center mt-2">
                                    <button @click="mysqlConfig.perf_schema = !mysqlConfig.perf_schema"
                                            :class="mysqlConfig.perf_schema ? 'bg-primary-500' : 'bg-gray-300'"
                                            class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
                                        <span :class="mysqlConfig.perf_schema ? 'translate-x-5' : 'translate-x-0'"
                                              class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out mt-0.5 ml-0.5"></span>
                                    </button>
                                    <span class="ml-3 text-sm text-gray-600" x-text="mysqlConfig.perf_schema ? 'ON' : 'OFF'"></span>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">Disabling saves ~100 MB RAM</p>
                            </div>
                        </div>

                        <div class="mt-6 flex items-center">
                            <button @click="saveMySQLConfig()" :disabled="mysqlConfigSaving"
                                    class="inline-flex items-center px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors disabled:opacity-50">
                                <svg x-show="mysqlConfigSaving" class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <span x-text="mysqlConfigSaving ? 'Restarting MySQL...' : 'Save & Restart MySQL'"></span>
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mt-6" x-show="systemSettingsTab === 'caddy' && caddyConfig">
                        <h3 class="text-lg font-semibold text-gray-800 mb-1">Caddy Performance Settings</h3>
                        <p class="text-sm text-gray-500 mb-6">Choose a server profile or use expert mode to tune advanced Caddy timeouts and limits.</p>

                        <div x-show="caddyConfigError" class="mb-4 p-3 bg-red-50 border border-red-200 text-red-700 rounded-lg text-sm" x-text="caddyConfigError"></div>
                        <div x-show="caddyConfigSuccess" class="mb-4 p-3 bg-green-50 border border-green-200 text-green-700 rounded-lg text-sm" x-text="caddyConfigSuccess"></div>

                        <div x-show="caddyConfig.expert_mode" class="mb-4 p-3 bg-amber-50 border border-amber-200 text-amber-700 rounded-lg text-sm">
                            Warning: Advanced Caddy settings can break websites, TLS behavior, or request routing if misconfigured. Change carefully.
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Profile</label>
                                <select x-model="caddyConfig.profile"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                    <option value="balanced">Balanced</option>
                                    <option value="low_ram">Low RAM</option>
                                    <option value="high_throughput">High Throughput</option>
                                </select>
                                <p class="text-xs text-gray-400 mt-1" x-show="caddyConfig.profile === 'balanced'">
                                    Recommended default for most servers. Keeps good responsiveness with safe resource usage.
                                </p>
                                <p class="text-xs text-gray-400 mt-1" x-show="caddyConfig.profile === 'low_ram'">
                                    Optimized for small VPS instances. Uses tighter limits to reduce memory and connection overhead.
                                </p>
                                <p class="text-xs text-gray-400 mt-1" x-show="caddyConfig.profile === 'high_throughput'">
                                    Optimized for bigger servers and heavy traffic. Allows longer keep-alive and larger headers.
                                </p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Access Logs</label>
                                <div class="flex items-center mt-2">
                                    <button @click="caddyConfig.access_logs = !caddyConfig.access_logs"
                                            :class="caddyConfig.access_logs ? 'bg-primary-500' : 'bg-gray-300'"
                                            class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
                                        <span :class="caddyConfig.access_logs ? 'translate-x-5' : 'translate-x-0'"
                                              class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out mt-0.5 ml-0.5"></span>
                                    </button>
                                    <span class="ml-3 text-sm text-gray-600" x-text="caddyConfig.access_logs ? 'Enabled (access + errors)' : 'Disabled (errors only)'"></span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Expert Mode</label>
                                <div class="flex items-center mt-2">
                                    <button @click="caddyConfig.expert_mode = !caddyConfig.expert_mode"
                                            :class="caddyConfig.expert_mode ? 'bg-primary-500' : 'bg-gray-300'"
                                            class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
                                        <span :class="caddyConfig.expert_mode ? 'translate-x-5' : 'translate-x-0'"
                                              class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out mt-0.5 ml-0.5"></span>
                                    </button>
                                    <span class="ml-3 text-sm text-gray-600" x-text="caddyConfig.expert_mode ? 'Enabled' : 'Disabled'"></span>
                                </div>
                            </div>
                        </div>

                        <div x-show="caddyConfig.expert_mode" class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">read_header</label>
                                <input type="text" x-model="caddyConfig.read_header" placeholder="10s"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">read_body</label>
                                <input type="text" x-model="caddyConfig.read_body" placeholder="30s"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">write</label>
                                <input type="text" x-model="caddyConfig.write_timeout" placeholder="90s"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">idle</label>
                                <input type="text" x-model="caddyConfig.idle_timeout" placeholder="90s"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">grace_period</label>
                                <input type="text" x-model="caddyConfig.grace_period" placeholder="8s"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">max_header_size (bytes)</label>
                                <input type="number" min="4096" max="262144" x-model.number="caddyConfig.max_header_size"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                            </div>
                        </div>

                        <div class="mt-6 flex items-center">
                            <button @click="saveCaddyConfig()" :disabled="caddyConfigSaving"
                                    class="inline-flex items-center px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors disabled:opacity-50">
                                <svg x-show="caddyConfigSaving" class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <span x-text="caddyConfigSaving ? 'Applying Caddy Settings...' : 'Save Caddy Settings'"></span>
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mt-6" x-show="systemSettingsTab === 'ssh' && sshConfig">
                        <h3 class="text-lg font-semibold text-gray-800 mb-1">SSH / SFTP Access Settings</h3>
                        <p class="text-sm text-gray-500 mb-6">Configure SSH daemon password authentication and listening port for server access.</p>

                        <div x-show="sshConfigError" class="mb-4 p-3 bg-red-50 border border-red-200 text-red-700 rounded-lg text-sm" x-text="sshConfigError"></div>
                        <div x-show="sshConfigSuccess" class="mb-4 p-3 bg-green-50 border border-green-200 text-green-700 rounded-lg text-sm" x-text="sshConfigSuccess"></div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">SSH Port</label>
                                <input type="number" min="1" max="65535" x-model.number="sshConfig.port"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                <p class="text-xs text-gray-400 mt-1">Default is 22. Ensure firewall allows the selected port.</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Password Authentication</label>
                                <div class="flex items-center mt-2">
                                    <button @click="sshConfig.password_auth = !sshConfig.password_auth"
                                            :class="sshConfig.password_auth ? 'bg-primary-500' : 'bg-gray-300'"
                                            class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
                                        <span :class="sshConfig.password_auth ? 'translate-x-5' : 'translate-x-0'"
                                              class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out mt-0.5 ml-0.5"></span>
                                    </button>
                                    <span class="ml-3 text-sm text-gray-600" x-text="sshConfig.password_auth ? 'Enabled' : 'Disabled'"></span>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">Disable this to enforce SSH key-based access only.</p>
                            </div>
                        </div>

                        <div class="mt-6 flex items-center">
                            <button @click="saveSSHConfig()" :disabled="sshConfigSaving"
                                    class="inline-flex items-center px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors disabled:opacity-50">
                                <svg x-show="sshConfigSaving" class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <span x-text="sshConfigSaving ? 'Applying SSH Settings...' : 'Save SSH Settings'"></span>
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mt-6" x-show="systemSettingsTab === 'firewall'">
                        <h3 class="text-lg font-semibold text-gray-800 mb-1">Firewall (UFW)</h3>
                        <p class="text-sm text-gray-500 mb-6">Install and manage host firewall rules. Control panel port <span class="font-mono">2050/tcp</span> is always protected.</p>

                        <div x-show="firewallError" class="mb-4 p-3 bg-red-50 border border-red-200 text-red-700 rounded-lg text-sm" x-text="firewallError"></div>
                        <div x-show="firewallSuccess" class="mb-4 p-3 bg-green-50 border border-green-200 text-green-700 rounded-lg text-sm" x-text="firewallSuccess"></div>

                        <div x-show="!firewallStatus?.installed" class="p-4 border border-gray-200 rounded-lg bg-gray-50">
                            <p class="text-sm text-gray-700 mb-3">UFW is not installed on this server.</p>
                            <button @click="installFirewall()" :disabled="firewallInstalling"
                                    class="inline-flex items-center px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors disabled:opacity-50">
                                <span x-text="firewallInstalling ? 'Installing UFW...' : 'Install UFW'"></span>
                            </button>
                        </div>

                        <div x-show="firewallStatus?.installed">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Firewall Status</label>
                                    <div class="flex items-center mt-2">
                                        <button @click="setFirewallEnabled(!(firewallStatus?.enabled))"
                                                :class="firewallStatus?.enabled ? 'bg-primary-500' : 'bg-gray-300'"
                                                :disabled="firewallSaving"
                                                class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full transition-colors duration-200 ease-in-out disabled:opacity-50">
                                            <span :class="firewallStatus?.enabled ? 'translate-x-5' : 'translate-x-0'"
                                                  class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out mt-0.5 ml-0.5"></span>
                                        </button>
                                        <span class="ml-3 text-sm text-gray-600" x-text="firewallStatus?.enabled ? 'Enabled' : 'Disabled'"></span>
                                    </div>
                                    <p class="text-xs text-gray-400 mt-1">Control panel port <span class="font-mono">2050/tcp</span> remains allowed.</p>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-5 gap-3 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Port</label>
                                    <input type="number" min="1" max="65535" x-model.number="firewallRuleForm.port"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Protocol</label>
                                    <select x-model="firewallRuleForm.protocol"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                        <option value="tcp">TCP</option>
                                        <option value="udp">UDP</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">IP Version</label>
                                    <select x-model="firewallRuleForm.ip_version"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                        <option value="both">IPv4 + IPv6</option>
                                        <option value="ipv4">IPv4 only</option>
                                        <option value="ipv6">IPv6 only</option>
                                    </select>
                                </div>
                                <div class="flex items-end">
                                    <button @click="firewallAllowPort()" :disabled="firewallSaving"
                                            class="w-full px-3 py-2 border border-gray-200 text-gray-700 rounded-lg hover:bg-gray-50 disabled:opacity-50">
                                        Allow Port
                                    </button>
                                </div>
                                <div class="flex items-end">
                                    <button @click="firewallDenyPort()" :disabled="firewallSaving"
                                            class="w-full px-3 py-2 border border-gray-200 text-gray-700 rounded-lg hover:bg-gray-50 disabled:opacity-50">
                                        Block Port
                                    </button>
                                </div>
                            </div>

                            <div class="overflow-x-auto border border-gray-100 rounded-lg">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Rule</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Action</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">IP</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">From</th>
                                            <th class="px-4 py-3 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-100">
                                        <template x-for="rule in (firewallStatus?.rules || [])" :key="rule.rule + '-' + rule.action + '-' + rule.from">
                                            <tr class="hover:bg-gray-50 transition-colors">
                                                <td class="px-4 py-3 text-sm font-mono text-gray-700" x-text="rule.rule"></td>
                                                <td class="px-4 py-3 text-sm text-gray-700" x-text="rule.action"></td>
                                                <td class="px-4 py-3 text-sm text-gray-500" x-text="rule.ip_version === 'ipv6' ? 'IPv6' : 'IPv4'"></td>
                                                <td class="px-4 py-3 text-sm text-gray-500" x-text="rule.from"></td>
                                                <td class="px-4 py-3 text-right">
                                                    <button @click="firewallDeleteRule(rule)" :disabled="firewallSaving || (rule.rule || '').startsWith((firewallStatus?.control_panel_port || 2050) + '/')"
                                                            class="inline-flex items-center justify-center w-8 h-8 rounded-lg border border-gray-200 text-gray-600 hover:bg-gray-50 hover:border-gray-300 transition-colors disabled:opacity-40"
                                                            title="Delete firewall rule">
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M9 7h6m-5-3h4a1 1 0 011 1v2H9V5a1 1 0 011-1z"></path>
                                                        </svg>
                                                    </button>
                                                </td>
                                            </tr>
                                        </template>
                                        <tr x-show="!firewallStatus?.rules || firewallStatus.rules.length === 0">
                                            <td colspan="5" class="px-4 py-8 text-center text-sm text-gray-500">No firewall rules yet</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Users Tab (Admin Only) -->
                <div x-show="tab === 'users'">
                    <div class="flex justify-between items-center mb-6">
                        <p class="text-gray-500">Manage system users and their resource limits</p>
                        <button @click="showCreateUser = true" 
                                class="inline-flex items-center px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Create User
                        </button>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Username</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Role</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Sites</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Resources</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Created</th>
                                    <th class="px-6 py-4 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                <template x-for="u in users" :key="u.id">
                                    <tr class="hover:bg-gray-50 transition-colors" :class="u.is_suspended ? 'bg-red-50' : ''">
                                        <td class="px-6 py-4 font-medium">
                                            <span x-text="u.username"></span>
                                            <span x-show="u.is_suspended" class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">Suspended</span>
                                        </td>
                                        <td class="px-6 py-4">
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                                  :class="u.is_admin ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-800'"
                                                  x-text="u.is_admin ? 'Admin' : 'User'"></span>
                                        </td>
                                        <td class="px-6 py-4 text-sm">
                                            <div class="space-y-1.5">
                                                <div class="flex items-center justify-between text-xs">
                                                    <span class="font-medium text-gray-700" x-text="u.site_count + ' used'"></span>
                                                    <span class="text-gray-500" x-text="u.max_sites === -1 ? 'Unlimited' : (u.max_sites + ' max')"></span>
                                                </div>
                                                <div class="h-1.5 bg-gray-100 rounded-full overflow-hidden" x-show="u.max_sites !== -1">
                                                    <div class="h-1.5 bg-primary-500 rounded-full"
                                                         :style="'width:' + Math.min(100, Math.round((u.site_count / Math.max(1, u.max_sites)) * 100)) + '%'"></div>
                                                </div>
                                                <span x-show="u.max_sites === -1" class="inline-flex items-center px-2 py-0.5 rounded-full bg-gray-100 text-gray-700 text-xs font-medium">No site limit</span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 text-sm">
                                            <div class="flex flex-wrap gap-1.5 text-xs">
                                                <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-gray-100 text-gray-700 font-medium">
                                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                                    </svg>
                                                    <span x-text="'RAM: ' + (u.memory_mb === -1 ? 'Unlimited' : (u.memory_mb + ' MB'))"></span>
                                                </span>
                                                <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-gray-100 text-gray-700 font-medium">
                                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 3v2.25M14.25 3v2.25M3 9.75h2.25M3 14.25h2.25M18.75 9.75H21M18.75 14.25H21M9.75 18.75V21M14.25 18.75V21M7.5 7.5h9v9h-9v-9z"></path>
                                                    </svg>
                                                    <span x-text="'CPU: ' + (u.cpu_percent === -1 ? 'Unlimited' : (u.cpu_percent + '%'))"></span>
                                                </span>
                                                <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-gray-100 text-gray-700 font-medium">
                                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 1.657 3.582 3 8 3s8-1.343 8-3V7M4 7c0 1.657 3.582 3 8 3s8-1.343 8-3M4 7c0-1.657 3.582-3 8-3s8 1.343 8 3"></path>
                                                    </svg>
                                                    <span x-text="'Storage: ' + (u.storage_mb === -1 ? 'Unlimited' : (u.storage_mb + ' MB'))"></span>
                                                </span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 text-sm text-gray-500" x-text="formatDate(u.created_at)"></td>
                                        <td class="px-6 py-4 text-right">
                                            <div class="inline-flex items-center gap-2">
                                            <button x-show="u.username !== 'root'"
                                                    @click="openEditUserResources(u)"
                                                    class="inline-flex items-center justify-center w-8 h-8 rounded-lg border border-gray-200 text-gray-600 hover:bg-gray-50 hover:border-gray-300 transition-colors"
                                                    title="Edit resource limits"
                                                    aria-label="Edit resource limits">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M7 12h10M10 18h4"></path>
                                                    <circle cx="9" cy="6" r="1.5" fill="currentColor"></circle>
                                                    <circle cx="15" cy="12" r="1.5" fill="currentColor"></circle>
                                                    <circle cx="12" cy="18" r="1.5" fill="currentColor"></circle>
                                                </svg>
                                            </button>
                                            <button x-show="user?.is_admin && !user?.is_impersonating && u.username !== 'root' && u.username !== user?.username && !u.is_admin"
                                                    @click="openImpersonateUser(u)"
                                                    class="inline-flex items-center justify-center w-8 h-8 rounded-lg border border-primary-200 text-primary-600 hover:bg-primary-50 hover:border-primary-300 transition-colors"
                                                    title="Login as user"
                                                    aria-label="Login as user">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 7a4 4 0 100 8 4 4 0 000-8z"></path>
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.5 20a7.5 7.5 0 0111 0"></path>
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8h3m0 0l-1.5-1.5M19 8l-1.5 1.5"></path>
                                                </svg>
                                            </button>
                                            <button x-show="u.username !== 'root' && u.username !== user?.username" 
                                                    @click="toggleUserSuspension(u)" 
                                                    :disabled="suspendingUser === u.username"
                                                    class="inline-flex items-center justify-center w-8 h-8 rounded-lg border transition-colors disabled:opacity-50"
                                                    :class="u.is_suspended ? 'border-gray-200 text-gray-600 hover:bg-gray-50 hover:border-gray-300' : 'border-gray-200 text-gray-600 hover:bg-gray-50 hover:border-gray-300'"
                                                    :title="u.is_suspended ? 'Unsuspend user' : 'Suspend user'"
                                                    :aria-label="u.is_suspended ? 'Unsuspend user' : 'Suspend user'">
                                                <template x-if="suspendingUser === u.username">
                                                    <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                    </svg>
                                                </template>
                                                <svg x-show="suspendingUser !== u.username && !u.is_suspended" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <circle cx="12" cy="12" r="9" stroke-width="2"></circle>
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6"></path>
                                                </svg>
                                                <svg x-show="suspendingUser !== u.username && u.is_suspended" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                </svg>
                                            </button>
                                            <button x-show="u.username !== 'root' && u.username !== user?.username" 
                                                    @click="deleteUser(u)" 
                                                    :disabled="deletingUser === u.username"
                                                    class="inline-flex items-center justify-center w-8 h-8 rounded-lg border border-red-200 text-red-600 hover:bg-red-50 hover:border-red-300 transition-colors disabled:opacity-50"
                                                    title="Delete user"
                                                    aria-label="Delete user">
                                                <template x-if="deletingUser === u.username">
                                                    <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                    </svg>
                                                </template>
                                                <svg x-show="deletingUser !== u.username" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M9 7h6m-5-3h4a1 1 0 011 1v2H9V5a1 1 0 011-1z"></path>
                                                </svg>
                                            </button>
                                            </div>
                                            <span x-show="u.username === 'root'" class="text-gray-400 text-sm">System</span>
                                            <span x-show="u.username === user?.username && u.username !== 'root'" class="text-gray-400 text-sm">You</span>
                                        </td>
                                    </tr>
                                </template>
                                <tr x-show="users.length === 0">
                                    <td colspan="6" class="px-6 py-16 text-center">
                                        <div class="flex flex-col items-center">
                                            <svg class="w-12 h-12 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                                            </svg>
                                            <p class="text-gray-500">No users yet</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Create Site Modal -->
    <div x-show="showCreateSite" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50" x-transition>
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md mx-4" @click.away="!creatingSite && (showCreateSite = false)">
            <!-- Creating Site Loading State -->
            <div x-show="creatingSite" class="text-center py-8">
                <div class="relative inline-flex mb-6">
                    <div class="w-16 h-16 bg-primary-100 rounded-full flex items-center justify-center">
                        <svg class="w-8 h-8 text-primary-500 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path>
                        </svg>
                    </div>
                    <div class="absolute inset-0 w-16 h-16 border-4 border-primary-500 border-t-transparent rounded-full animate-spin"></div>
                </div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Creating Your Site</h3>
                <p class="text-gray-500 mb-4" x-text="newSite.domain"></p>
                <div class="space-y-3">
                    <div class="flex items-center justify-center text-sm" :class="siteCreationStatus ? 'text-primary-600' : 'text-gray-400'">
                        <svg class="w-4 h-4 mr-2 animate-spin" x-show="siteCreationStatus" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span x-text="siteCreationStatus || 'Initializing...'"></span>
                    </div>
                </div>
                <p class="text-xs text-gray-400 mt-6" x-show="newSite.site_type === 'wordpress'">
                    WordPress installation may take a minute...
                </p>
            </div>

            <!-- Error State -->
            <div x-show="siteCreationError && !creatingSite" class="text-center py-8">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Creation Failed</h3>
                <p class="text-red-600 text-sm mb-6" x-text="siteCreationError"></p>
                <button @click="siteCreationError = ''" class="px-6 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium">Try Again</button>
            </div>

            <!-- Form State -->
            <div x-show="!creatingSite && !siteCreationError">
                <h3 class="text-xl font-semibold text-gray-800 mb-6">Create New Site</h3>
                <form @submit.prevent="createSite">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Domain</label>
                        <div class="relative">
                            <input type="text" x-model="newSite.domain" required
                                   @input="validateDomainAndGenerateSlug()"
                                   class="w-full px-4 py-3 border rounded-lg focus:outline-none pr-10"
                                   :class="domainValidation.valid === true ? 'border-green-300 focus:border-green-500' : domainValidation.valid === false ? 'border-red-300 focus:border-red-500' : 'border-gray-200 focus:border-primary-500'"
                                   placeholder="example.com">
                            <div class="absolute right-3 top-1/2 -translate-y-1/2">
                                <svg x-show="domainValidation.valid === true" class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <svg x-show="domainValidation.valid === false" class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </div>
                        </div>
                        <p class="text-xs mt-1" :class="domainValidation.valid === true ? 'text-green-600' : domainValidation.valid === false ? 'text-red-600' : 'text-gray-500'"
                           x-text="domainValidation.message || 'Enter your domain name'"></p>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Directory Name (Slug)</label>
                        <div class="relative">
                            <input type="text" x-model="newSite.slug" required
                                   @input="validateSlug()"
                                   class="w-full px-4 py-3 border rounded-lg focus:outline-none font-mono text-sm pr-10"
                                   :class="slugValidation.valid === true ? 'border-green-300 focus:border-green-500' : slugValidation.valid === false ? 'border-red-300 focus:border-red-500' : 'border-gray-200 focus:border-primary-500'"
                                   placeholder="example_com">
                            <div class="absolute right-3 top-1/2 -translate-y-1/2">
                                <svg x-show="slugValidation.valid === true" class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <svg x-show="slugValidation.valid === false" class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </div>
                        </div>
                        <p class="text-xs mt-2" :class="slugValidation.valid === true ? 'text-green-600' : slugValidation.valid === false ? 'text-red-600' : 'text-gray-500'"
                           x-text="slugValidation.message || 'Site will be created at: /home/' + (user?.username || 'user') + '/apps/' + (newSite.slug || 'slug') + '/public'"></p>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Type</label>
                        <select x-model="newSite.site_type" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-primary-500">
                            <option value="php">PHP</option>
                            <option value="wordpress">WordPress</option>
                        </select>
                        <p class="text-xs text-gray-400 mt-2" x-show="newSite.site_type === 'wordpress'">
                            WordPress will be automatically installed with a fresh database
                        </p>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">PHP Version</label>
                        <select x-model="newSite.php_version" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-primary-500">
                            <template x-for="version in getAvailablePHPVersions()" :key="'new-site-php-' + version">
                                <option :value="version" x-text="version"></option>
                            </template>
                        </select>
                    </div>
                    <div class="flex space-x-3">
                        <button type="button" @click="showCreateSite = false; resetSiteValidation()" class="flex-1 px-4 py-3 border border-gray-200 rounded-lg hover:bg-gray-50 font-medium">Cancel</button>
                        <button type="submit" :disabled="domainValidation.valid === false || slugValidation.valid === false" 
                                class="flex-1 px-4 py-3 bg-primary-500 text-white rounded-lg hover:bg-primary-600 font-medium disabled:opacity-50 disabled:cursor-not-allowed">Create Site</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Create Database Modal -->
    <div x-show="showCreateDatabase" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50" x-transition>
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md mx-4" @click.away="showCreateDatabase = false">
            <h3 class="text-xl font-semibold text-gray-800 mb-6">Create Database</h3>
            <form @submit.prevent="createDatabase">
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Name</label>
                    <div class="flex">
                        <span class="inline-flex items-center px-4 bg-gray-100 border border-r-0 border-gray-200 rounded-l-lg text-sm text-gray-500" x-text="user?.username + '_'"></span>
                        <input type="text" x-model="newDatabase.name" required
                               class="flex-1 px-4 py-3 border border-gray-200 rounded-r-lg focus:outline-none focus:border-primary-500"
                               placeholder="mydb">
                    </div>
                </div>
                <div class="flex space-x-3">
                    <button type="button" @click="showCreateDatabase = false" class="flex-1 px-4 py-3 border border-gray-200 rounded-lg hover:bg-gray-50 font-medium">Cancel</button>
                    <button type="submit" class="flex-1 px-4 py-3 bg-primary-500 text-white rounded-lg hover:bg-primary-600 font-medium">Create</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add SSH Key Modal -->
    <div x-show="showAddSSHKey" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50" x-transition>
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-lg mx-4" @click.away="showAddSSHKey = false; sshKeyError = ''">
            <h3 class="text-xl font-semibold text-gray-800 mb-6">Add SSH Key</h3>
            <form @submit.prevent="addSSHKey">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Name</label>
                    <input type="text" x-model="newSSHKey.name" required
                           class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-primary-500" 
                           placeholder="My Laptop">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Public Key</label>
                    <textarea x-model="newSSHKey.public_key" required rows="4"
                              class="w-full px-4 py-3 border border-gray-200 rounded-lg font-mono text-sm focus:outline-none focus:border-primary-500"
                              placeholder="ssh-rsa AAAA... or ssh-ed25519 AAAA..."></textarea>
                    <p class="text-xs text-gray-500 mt-1">Add the public key from your OpenSSH key pair here (for example: <span class="font-mono">~/.ssh/id_ed25519.pub</span> or <span class="font-mono">~/.ssh/id_rsa.pub</span>).</p>
                </div>
                <div x-show="sshKeyError" class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4 text-sm">
                    <span x-text="sshKeyError"></span>
                </div>
                <div class="flex space-x-3">
                    <button type="button" @click="showAddSSHKey = false; sshKeyError = ''" class="flex-1 px-4 py-3 border border-gray-200 rounded-lg hover:bg-gray-50 font-medium">Cancel</button>
                    <button type="submit" class="flex-1 px-4 py-3 bg-primary-500 text-white rounded-lg hover:bg-primary-600 font-medium">Add Key</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Cron Job Modal -->
    <div x-show="showEditCron" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50" x-transition>
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-lg mx-4" @click.away="showEditCron = false; resetCronForm()">
            <h3 class="text-xl font-semibold text-gray-800 mb-6">Edit Cron Job</h3>
            <form @submit.prevent="updateCronJob()">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Name</label>
                    <input type="text" x-model="cronForm.name" required
                           class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-primary-500" 
                           placeholder="e.g., Database Backup">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Schedule (Cron Expression)</label>
                    <div class="relative">
                        <input type="text" x-model="cronForm.expression" required
                               @input="validateCronExpression()"
                               class="w-full px-4 py-3 border rounded-lg focus:outline-none font-mono text-sm"
                               :class="cronValidation.valid === true ? 'border-green-300 focus:border-green-500' : cronValidation.valid === false ? 'border-red-300 focus:border-red-500' : 'border-gray-200 focus:border-primary-500'"
                               placeholder="*/5 * * * *">
                        <div class="absolute right-3 top-1/2 -translate-y-1/2">
                            <svg x-show="cronValidation.valid === true" class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            <svg x-show="cronValidation.valid === false" class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </div>
                    </div>
                    <p class="text-xs mt-2" :class="cronValidation.valid === true ? 'text-green-600' : cronValidation.valid === false ? 'text-red-600' : 'text-gray-500'"
                       x-text="cronValidation.description || 'Format: minute hour day month weekday'"></p>
                </div>

                <!-- Quick preset buttons -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Quick Presets</label>
                    <div class="flex flex-wrap gap-2">
                        <button type="button" @click="setCronPreset('*/5 * * * *')" class="px-3 py-1.5 text-xs bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">Every 5 min</button>
                        <button type="button" @click="setCronPreset('0 * * * *')" class="px-3 py-1.5 text-xs bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">Hourly</button>
                        <button type="button" @click="setCronPreset('0 0 * * *')" class="px-3 py-1.5 text-xs bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">Daily</button>
                        <button type="button" @click="setCronPreset('0 0 * * 0')" class="px-3 py-1.5 text-xs bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">Weekly</button>
                        <button type="button" @click="setCronPreset('0 0 1 * *')" class="px-3 py-1.5 text-xs bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">Monthly</button>
                        <button type="button" @click="setCronPreset('0 3 * * *')" class="px-3 py-1.5 text-xs bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">3 AM Daily</button>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Command</label>
                    <textarea x-model="cronForm.command" required rows="3"
                              class="w-full px-4 py-3 border border-gray-200 rounded-lg font-mono text-sm focus:outline-none focus:border-primary-500"
                              placeholder="/usr/bin/php /home/user/apps/site/cron.php"></textarea>
                    <p class="text-xs text-gray-500 mt-1">Use absolute paths. Output is captured in user's cron logs.</p>
                    <div class="mt-3">
                        <p class="text-xs font-medium text-gray-700 mb-2">PHP CLI Paths</p>
                        <div class="flex flex-wrap gap-2">
                            <template x-for="phpPath in cronPHPCLIPaths()" :key="'cron-edit-php-' + phpPath">
                                <button type="button"
                                        @click="copyCronPath(phpPath)"
                                        class="inline-flex items-center gap-2 px-2.5 py-1.5 border border-gray-200 rounded-md bg-gray-50 hover:bg-gray-100 text-xs font-mono text-gray-700">
                                    <span x-text="phpPath"></span>
                                    <span class="text-[11px] font-medium text-primary-600">Copy</span>
                                </button>
                            </template>
                        </div>
                        <p x-show="cronHelperMessage" class="text-xs text-green-600 mt-1" x-text="cronHelperMessage"></p>
                    </div>
                </div>

                <div x-show="cronError" class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4 text-sm">
                    <span x-text="cronError"></span>
                </div>

                <div class="flex space-x-3">
                    <button type="button" @click="showEditCron = false; resetCronForm()" class="flex-1 px-4 py-3 border border-gray-200 rounded-lg hover:bg-gray-50 font-medium">Cancel</button>
                    <button type="submit" :disabled="cronValidation.valid === false"
                            class="flex-1 px-4 py-3 bg-primary-500 text-white rounded-lg hover:bg-primary-600 font-medium disabled:opacity-50 disabled:cursor-not-allowed">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create User Modal -->
    <div x-show="showCreateUser" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50" x-transition>
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md mx-4" @click.away="if(!creatingUser) showCreateUser = false">
            <h3 class="text-xl font-semibold text-gray-800 mb-6">Create New User</h3>
            <form @submit.prevent="createUser">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" x-model="newUser.username" required pattern="[a-z_][a-z0-9_-]*"
                           class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-primary-500"
                           placeholder="username">
                    <p class="text-xs text-gray-500 mt-1">Lowercase letters, numbers, underscores, hyphens</p>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" x-model="newUser.password" required minlength="8"
                           class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-primary-500"
                           placeholder="Minimum 8 characters">
                </div>
                <div class="mb-4 grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Memory (MB)</label>
                        <input type="number" x-model.number="newUser.memory_mb" min="128" max="16384"
                               class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-primary-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">CPU (%)</label>
                        <input type="number" x-model.number="newUser.cpu_percent" min="10" max="400"
                               class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-primary-500">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Max Sites</label>
                    <input type="number" x-model.number="newUser.max_sites" min="-1"
                           class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-primary-500">
                    <p class="text-xs text-gray-500 mt-1">-1 = unlimited</p>
                </div>
                <div class="mb-6">
                    <label class="flex items-center">
                        <input type="checkbox" x-model="newUser.is_admin" class="w-4 h-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500 mr-3">
                        <span class="text-sm text-gray-700">Administrator privileges</span>
                    </label>
                </div>
                <div x-show="userError" class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4 text-sm">
                    <span x-text="userError"></span>
                </div>
                <div class="flex space-x-3">
                    <button type="button" @click="showCreateUser = false; userError = ''" :disabled="creatingUser" class="flex-1 px-4 py-3 border border-gray-200 rounded-lg hover:bg-gray-50 font-medium disabled:opacity-50">Cancel</button>
                    <button type="submit" :disabled="creatingUser" class="flex-1 px-4 py-3 bg-primary-500 text-white rounded-lg hover:bg-primary-600 font-medium disabled:opacity-50 flex items-center justify-center">
                        <template x-if="creatingUser">
                            <svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </template>
                        <span x-text="creatingUser ? 'Creating...' : 'Create User'"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit User Limits Modal -->
    <div x-show="showEditUserResources" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50" x-transition>
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md mx-4" @click.away="if(!savingUserResources) showEditUserResources = false">
            <h3 class="text-xl font-semibold text-gray-800 mb-1">Edit User Limits</h3>
            <p class="text-sm text-gray-500 mb-6">
                Update limits for <span class="font-mono" x-text="editingUserResources?.username"></span>
            </p>
            <form @submit.prevent="saveUserResources">
                <div class="mb-4 grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Memory (MB)</label>
                        <input type="number" x-model.number="editUserResourcesForm.memory_mb" required
                               class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-primary-500">
                        <p class="text-xs text-gray-500 mt-1">Set to -1 for unlimited</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">CPU (%)</label>
                        <input type="number" x-model.number="editUserResourcesForm.cpu_percent" required
                               class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-primary-500">
                        <p class="text-xs text-gray-500 mt-1">Set to -1 for unlimited</p>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Max Sites</label>
                    <input type="number" x-model.number="editUserResourcesForm.max_sites" min="-1"
                           class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-primary-500">
                    <p class="text-xs text-gray-500 mt-1">-1 = unlimited</p>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Storage (MB)</label>
                    <input type="number" x-model.number="editUserResourcesForm.storage_mb" min="-1"
                           class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-primary-500">
                    <p class="text-xs text-gray-500 mt-1">-1 = unlimited</p>
                </div>
                <div x-show="editUserResourcesError" class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4 text-sm">
                    <span x-text="editUserResourcesError"></span>
                </div>
                <div class="flex space-x-3">
                    <button type="button" @click="showEditUserResources = false; editUserResourcesError = ''" :disabled="savingUserResources" class="flex-1 px-4 py-3 border border-gray-200 rounded-lg hover:bg-gray-50 font-medium disabled:opacity-50">Cancel</button>
                    <button type="submit" :disabled="savingUserResources" class="flex-1 px-4 py-3 bg-primary-500 text-white rounded-lg hover:bg-primary-600 font-medium disabled:opacity-50 flex items-center justify-center">
                        <template x-if="savingUserResources">
                            <svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </template>
                        <span x-text="savingUserResources ? 'Saving...' : 'Save Limits'"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Database Created Modal -->
    <div x-show="createdDatabase" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50" x-transition>
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md mx-4">
            <div class="flex items-center mb-4">
                <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3">
                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-semibold text-gray-800">Database Created!</h3>
            </div>
            <div class="bg-gray-50 rounded-lg p-4 mb-4 font-mono text-sm space-y-2">
                <div class="flex justify-between"><span class="text-gray-500">Database:</span> <span x-text="createdDatabase?.db_name"></span></div>
                <div class="flex justify-between"><span class="text-gray-500">User:</span> <span x-text="createdDatabase?.db_user"></span></div>
                <div class="flex justify-between"><span class="text-gray-500">Password:</span> <span class="text-primary-600" x-text="createdDatabase?.password"></span></div>
                <div class="flex justify-between"><span class="text-gray-500">Host:</span> <span>localhost</span></div>
            </div>
            <p class="text-sm text-amber-600 mb-4 flex items-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
                Save this password! It won't be shown again.
            </p>
            <button @click="createdDatabase = null" class="w-full px-4 py-3 bg-primary-500 text-white rounded-lg hover:bg-primary-600 font-medium">Got it</button>
        </div>
    </div>

    <!-- Database Password Reset Modal -->
    <div x-show="resetDatabaseResult" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50" x-transition>
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md mx-4">
            <div class="flex items-center mb-4">
                <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c1.657 0 3-1.567 3-3.5S13.657 4 12 4 9 5.567 9 7.5 10.343 11 12 11zm0 0v2m-6 7h12a2 2 0 002-2v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2a2 2 0 002 2z"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-semibold text-gray-800">Database Password Reset</h3>
            </div>
            <div class="bg-gray-50 rounded-lg p-4 mb-4 font-mono text-sm space-y-2">
                <div class="flex justify-between"><span class="text-gray-500">Database:</span> <span x-text="resetDatabaseResult?.db_name"></span></div>
                <div class="flex justify-between"><span class="text-gray-500">User:</span> <span x-text="resetDatabaseResult?.db_user"></span></div>
                <div class="flex justify-between"><span class="text-gray-500">New Password:</span> <span class="text-primary-600" x-text="resetDatabaseResult?.password"></span></div>
                <div class="flex justify-between"><span class="text-gray-500">Host:</span> <span>localhost</span></div>
            </div>
            <p class="text-sm text-amber-600 mb-4 flex items-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
                Save this password! It won't be shown again.
            </p>
            <button @click="resetDatabaseResult = null" class="w-full px-4 py-3 bg-primary-500 text-white rounded-lg hover:bg-primary-600 font-medium">Got it</button>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div x-show="showConfirmModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50" x-transition @keydown.escape.window="cancelConfirmation()">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md mx-4" @click.away="cancelConfirmation()">
            <div class="flex items-start">
                <div class="w-11 h-11 rounded-full bg-red-100 flex items-center justify-center mr-3 flex-shrink-0">
                    <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-900" x-text="confirmModalTitle"></h3>
                    <p class="text-sm text-gray-600 mt-1" x-text="confirmModalMessage"></p>
                </div>
            </div>
            <div class="mt-6 flex space-x-3">
                <button @click="cancelConfirmation()" class="flex-1 px-4 py-3 border border-gray-200 rounded-lg hover:bg-gray-50 font-medium">Cancel</button>
                <button @click="acceptConfirmation()" class="flex-1 px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium" x-text="confirmModalConfirmText"></button>
            </div>
        </div>
    </div>

    <!-- Impersonate User Modal -->
    <div x-show="showImpersonateUserModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50" x-transition>
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md mx-4" @click.away="if(!impersonationStarting) { showImpersonateUserModal = false; impersonationError = ''; }">
            <div class="flex items-center mb-4">
                <div class="w-10 h-10 rounded-full bg-primary-100 flex items-center justify-center mr-3">
                    <svg class="w-5 h-5 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 7a4 4 0 100 8 4 4 0 000-8z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.5 20a7.5 7.5 0 0111 0"></path>
                    </svg>
                </div>
                <div>
                    <h3 class="text-xl font-semibold text-gray-800">Login as User</h3>
                    <p class="text-sm text-gray-500">Start a short-lived audited impersonation session</p>
                </div>
            </div>

            <form @submit.prevent="startImpersonation()" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Target User</label>
                    <input type="text" x-model="impersonateForm.target_username" readonly
                           class="w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 text-gray-700">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Confirm Admin Password</label>
                    <input type="password" x-model="impersonateForm.admin_password" required
                           placeholder="Enter your current password"
                           class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-primary-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Reason (Optional)</label>
                    <input type="text" x-model="impersonateForm.reason"
                           placeholder="Support, troubleshooting, migration..."
                           class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-primary-500">
                </div>

                <div x-show="impersonationError" class="text-red-600 text-sm bg-red-50 border border-red-200 rounded-lg p-3" x-text="impersonationError"></div>

                <div class="rounded-lg bg-amber-50 border border-amber-200 p-3 text-xs text-amber-800">
                    You will act with this user's permissions only. Actions are audited with admin, target user, IP, user-agent, and timestamp.
                </div>

                <div class="flex gap-3 pt-2">
                    <button type="button"
                            @click="showImpersonateUserModal = false; impersonationError = ''; impersonateForm.admin_password = ''; impersonateForm.reason = '';"
                            :disabled="impersonationStarting"
                            class="flex-1 px-4 py-2 border border-gray-200 rounded-lg hover:bg-gray-50 disabled:opacity-50">
                        Cancel
                    </button>
                    <button type="submit"
                            :disabled="impersonationStarting"
                            class="flex-1 px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 disabled:opacity-50">
                        <span x-text="impersonationStarting ? 'Starting...' : 'Login as User'"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API = '/api';
        const ADMIN_IMPERSONATION_BACKUP_TOKEN_KEY = 'fastcp_admin_token_backup';
        const ADMIN_IMPERSONATION_BACKUP_USER_KEY = 'fastcp_admin_user_backup';

        function app() {
            return {
                authenticated: false,
                token: localStorage.getItem('fastcp_token'),
                user: null,
                username: '',
                password: '',
                loading: false,
                error: '',
                tab: 'dashboard',
                systemSettingsTab: 'php',
                showCreateSite: false,
                showCreateDatabase: false,
                showAddSSHKey: false,
                showCreateUser: false,
                showImpersonateUserModal: false,
                showConfirmModal: false,
                confirmModalTitle: '',
                confirmModalMessage: '',
                confirmModalConfirmText: 'Delete',
                confirmModalResolver: null,
                sites: [],
                sitesTotal: 0,
                sitesPage: 1,
                sitesLimit: 10,
                sitesSearch: '',
                databases: [],
                databasesTotal: 0,
                databasesPage: 1,
                databasesLimit: 10,
                databasesSearch: '',
                sshKeys: [],
                users: [],
                systemStatus: null,
                createdDatabase: null,
                resetDatabaseResult: null,
                deletingSiteId: null,
                deletingDatabaseId: null,
                userError: '',
                newSite: { domain: '', slug: '', site_type: 'php', php_version: '8.4' },
                domainValidation: { valid: null, message: '' },
                domainValidateTimeout: null,
                slugValidation: { valid: null, message: '' },
                slugValidateTimeout: null,
                newDatabase: { name: '' },
                newSSHKey: { name: '', public_key: '' },
                sshKeyError: '',
                newUser: { username: '', password: '', is_admin: false, memory_mb: 512, cpu_percent: 100, max_sites: -1, storage_mb: -1 },
                impersonateForm: { target_username: '', admin_password: '', reason: '' },
                impersonationError: '',
                impersonationStarting: false,
                impersonationStopping: false,
                creatingUser: false,
                showEditUserResources: false,
                editingUserResources: null,
                editUserResourcesForm: { memory_mb: 512, cpu_percent: 100, max_sites: -1, storage_mb: -1 },
                editUserResourcesError: '',
                savingUserResources: false,
                deletingUser: null,
                suspendingUser: null,
                updateInfo: null,
                updateLoading: false,
                updateChecking: false,
                updateError: '',
                updateProgress: 0,
                updateStatus: '',
                publicIP: '',
                publicIPLoaded: false,
                creatingSite: false,
                siteCreationStatus: '',
                siteCreationError: '',
                siteSettingsTab: 'general',
                managingSite: null,
                newDomain: { domain: '', redirect_to_primary: false },
                domainLoading: false,
                domainError: '',
                siteSettingsForm: {
                    force_https: true,
                    compression_enabled: true,
                    gzip_enabled: true,
                    zstd_enabled: true,
                    cache_control_enabled: false,
                    cache_control_value: '',
                    php_version: '8.4',
                    php_memory_limit: '256M',
                    php_post_max_size: '64M',
                    php_upload_max_filesize: '64M',
                    php_max_execution_time: 300,
                    php_max_input_vars: 5000
                },
                savingSiteSettings: false,
                siteSettingsError: '',
                siteSettingsSuccess: '',
                
                // MySQL config
                phpDefaultConfig: null,
                phpDefaultConfigLoading: false,
                phpDefaultConfigSaving: false,
                phpVersionInstalling: {},
                phpDefaultConfigError: '',
                phpDefaultConfigSuccess: '',
                mysqlConfig: null,
                mysqlConfigLoading: false,
                mysqlConfigSaving: false,
                mysqlConfigError: '',
                mysqlConfigSuccess: '',
                caddyConfig: null,
                caddyConfigLoading: false,
                caddyConfigSaving: false,
                caddyConfigError: '',
                caddyConfigSuccess: '',
                firewallStatus: null,
                firewallLoading: false,
                firewallSaving: false,
                firewallInstalling: false,
                firewallError: '',
                firewallSuccess: '',
                firewallRuleForm: { port: null, protocol: 'tcp', ip_version: 'both' },
                sshConfig: null,
                sshConfigLoading: false,
                sshConfigSaving: false,
                sshConfigError: '',
                sshConfigSuccess: '',
                sshConnectionPort: 22,
                showSFTPHelp: false,

                // Backups
                backupConfig: null,
                backupForm: {
                    backend_type: 'sftp',
                    repository: '',
                    repository_password: '',
                    local_path: '',
                    sftp_username: '',
                    sftp_host: '',
                    sftp_port: 22,
                    sftp_path: '',
                    s3_endpoint: '',
                    s3_bucket: '',
                    s3_prefix: '',
                    s3_region: '',
                    s3_bucket_lookup: 'auto',
                    s3_list_objects_v1: false,
                    s3_access_key_id: '',
                    s3_secret_access_key: '',
                    s3_session_token: '',
                    rclone_repository: '',
                    enabled: false,
                    schedule_cron: '0 2 * * *',
                    exclude_site_ids: [],
                    exclude_database_ids: [],
                    keep_last: 7,
                    keep_daily: 7,
                    keep_weekly: 4,
                    keep_monthly: 6
                },
                backupJobs: [],
                backupSnapshots: [],
                backupSaving: false,
                backupTesting: false,
                backupRunningNow: false,
                backupError: '',
                backupSuccess: '',
                backupRcloneStatus: null,
                backupRcloneInstalling: false,
                backupViewTab: 'snapshots',
                backupRestoreFilterType: 'all',
                backupRestoreFilterSiteID: '',
                backupRestoreFilterDatabaseID: '',
                expandedSnapshotId: '',
                backupSnapshotDeleting: false,
                backupSnapshotDownloading: false,
                restoreLoading: false,

                // Cron jobs
                cronJobs: [],
                showCronCreateForm: false,
                showEditCron: false,
                cronForm: { id: '', name: '', expression: '', command: '' },
                cronValidation: { valid: null, description: '', error: '' },
                cronError: '',
                cronHelperMessage: '',
                cronValidateTimeout: null,

                get tabTitle() {
                    const titles = {
                        'dashboard': 'Dashboard',
                        'sites': 'Sites',
                        'site-settings': 'Website Settings',
                        'databases': 'Databases',
                        'backups': 'Backups',
                        'ssh': 'SSH & SFTP',
                        'cron': 'Cron Jobs',
                        'system': 'System',
                        'users': 'Users'
                    };
                    return titles[this.tab] || 'Dashboard';
                },

                async init() {
                    if (this.token) {
                        try {
                            await this.fetchUser();
                            if (!this.user?.is_impersonating) {
                                localStorage.removeItem(ADMIN_IMPERSONATION_BACKUP_TOKEN_KEY);
                                localStorage.removeItem(ADMIN_IMPERSONATION_BACKUP_USER_KEY);
                            }
                            this.authenticated = true;
                            this.handleHashRoute();
                            window.addEventListener('hashchange', () => this.handleHashRoute());
                            if (this.user?.is_admin) {
                                this.checkUpdate(false);
                            }
                        } catch (e) {
                            localStorage.removeItem('fastcp_token');
                            this.token = null;
                        }
                    }
                },

                handleHashRoute() {
                    const hash = window.location.hash.slice(1) || 'dashboard';
                    const validTabs = ['dashboard', 'sites', 'site-settings', 'databases', 'backups', 'ssh', 'cron', 'users', 'system'];
                    const adminTabs = ['users', 'system'];
                    
                    if (validTabs.includes(hash)) {
                        if (adminTabs.includes(hash) && !this.user?.is_admin) {
                            this.navigate('dashboard');
                            return;
                        }
                        if (hash === 'site-settings' && !this.managingSite) {
                            this.navigate('sites');
                            return;
                        }
                        this.tab = hash;
                        this.loadTabData(hash);
                    } else {
                        this.navigate('dashboard');
                    }
                },

                navigate(tabName) {
                    window.location.hash = tabName;
                },

                loadTabData(tab) {
                    switch(tab) {
                        case 'dashboard': this.loadSystemStatus(); break;
                        case 'sites': this.loadSites(); break;
                        case 'site-settings': break;
                        case 'databases': this.loadDatabases(); break;
                        case 'backups': this.loadBackups(); break;
                        case 'ssh': this.loadSSHKeys(); this.loadSystemStatus(); this.loadPublicIP(); if (this.user?.is_admin) this.loadSSHConfig(); break;
                        case 'cron': this.loadCronJobs(); this.loadSystemStatus(); break;
                        case 'users': this.loadUsers(); break;
                        case 'system': this.loadSystemStatus(); this.loadPHPDefaultConfig(); this.loadMySQLConfig(); this.loadCaddyConfig(); this.loadSSHConfig(); this.loadFirewallStatus(); break;
                    }
                },

                async login() {
                    this.loading = true;
                    this.error = '';
                    try {
                        const resp = await fetch(`${API}/auth/login`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ username: this.username, password: this.password })
                        });
                        const data = await resp.json();
                        if (!resp.ok) throw new Error(data.error || 'Login failed');
                        this.token = data.token;
                        this.user = data.user;
                        localStorage.setItem('fastcp_token', this.token);
                        localStorage.removeItem(ADMIN_IMPERSONATION_BACKUP_TOKEN_KEY);
                        localStorage.removeItem(ADMIN_IMPERSONATION_BACKUP_USER_KEY);
                        this.authenticated = true;
                        this.password = '';
                        
                        // Check for redirect parameter
                        const urlParams = new URLSearchParams(window.location.search);
                        const redirect = urlParams.get('redirect');
                        if (redirect === 'phpmyadmin') {
                            window.history.replaceState({}, '', '/');
                            this.activeTab = 'databases';
                            this.loadDatabases();
                            return;
                        }
                        
                        // Clear URL params and continue
                        if (window.location.search) {
                            window.history.replaceState({}, '', window.location.pathname);
                        }
                        
                        window.addEventListener('hashchange', () => this.handleHashRoute());
                        this.handleHashRoute();
                        if (this.user?.is_admin) {
                            this.checkUpdate(false);
                        }
                    } catch (e) {
                        this.error = e.message;
                    } finally {
                        this.loading = false;
                    }
                },

                async logout() {
                    await this.api('/auth/logout', 'POST').catch(() => {});
                    localStorage.removeItem('fastcp_token');
                    localStorage.removeItem(ADMIN_IMPERSONATION_BACKUP_TOKEN_KEY);
                    localStorage.removeItem(ADMIN_IMPERSONATION_BACKUP_USER_KEY);
                    this.token = null;
                    this.authenticated = false;
                    this.user = null;
                },

                async fetchUser() {
                    this.user = await this.api('/auth/me');
                },

                async loadSites() {
                    const params = `?page=${this.sitesPage}&limit=${this.sitesLimit}&search=${encodeURIComponent(this.sitesSearch)}`;
                    const result = await this.api('/sites' + params);
                    this.sites = result?.data || [];
                    this.sitesTotal = result?.total || 0;
                },
                async loadDatabases() {
                    const params = `?page=${this.databasesPage}&limit=${this.databasesLimit}&search=${encodeURIComponent(this.databasesSearch)}`;
                    const result = await this.api('/databases' + params);
                    this.databases = result?.data || [];
                    this.databasesTotal = result?.total || 0;
                },
                async loadBackups() {
                    this.backupError = '';
                    this.backupSuccess = '';
                    const results = await Promise.allSettled([
                        this.loadBackupConfig(),
                        this.loadBackupRcloneStatus(),
                        this.loadBackupJobs(),
                        this.loadBackupSnapshots()
                    ]);
                    const failed = results.find(r => r.status === 'rejected');
                    if (failed && failed.reason) {
                        this.backupError = failed.reason?.message || 'Failed to load backup data';
                    }
                },
                async loadBackupConfig() {
                    this.backupConfig = await this.api('/backups/config');
                    const cfg = this.backupConfig || {};
                    const backendType = (cfg.backend_type || 'sftp').toLowerCase();
                    const repo = (cfg.repository || '').trim();
                    this.backupForm = {
                        backend_type: backendType,
                        repository: repo,
                        repository_password: '',
                        local_path: backendType === 'local' ? repo : '',
                        sftp_username: cfg.sftp_username || (this.user?.username || ''),
                        sftp_host: cfg.sftp_host || '',
                        sftp_port: Number.isFinite(cfg.sftp_port) ? cfg.sftp_port : 22,
                        sftp_path: cfg.sftp_path || '',
                        s3_endpoint: cfg.s3_endpoint || '',
                        s3_bucket: cfg.s3_bucket || '',
                        s3_prefix: cfg.s3_prefix || '',
                        s3_region: cfg.s3_region || '',
                        s3_bucket_lookup: cfg.s3_bucket_lookup || 'auto',
                        s3_list_objects_v1: !!cfg.s3_list_objects_v1,
                        s3_access_key_id: '',
                        s3_secret_access_key: '',
                        s3_session_token: '',
                        rclone_repository: backendType === 'rclone' ? repo : '',
                        enabled: !!cfg.enabled,
                        schedule_cron: cfg.schedule_cron || '0 2 * * *',
                        exclude_site_ids: Array.isArray(cfg.exclude_site_ids) ? [...cfg.exclude_site_ids] : [],
                        exclude_database_ids: Array.isArray(cfg.exclude_database_ids) ? [...cfg.exclude_database_ids] : [],
                        keep_last: Number.isFinite(cfg.keep_last) ? cfg.keep_last : 7,
                        keep_daily: Number.isFinite(cfg.keep_daily) ? cfg.keep_daily : 7,
                        keep_weekly: Number.isFinite(cfg.keep_weekly) ? cfg.keep_weekly : 4,
                        keep_monthly: Number.isFinite(cfg.keep_monthly) ? cfg.keep_monthly : 6
                    };
                },
                setBackupSchedulePreset(expr) {
                    this.backupForm.schedule_cron = (expr || '').trim();
                },
                isBackupSchedulePreset(expr) {
                    return (this.backupForm?.schedule_cron || '').trim() === (expr || '').trim();
                },
                async loadBackupRcloneStatus() {
                    this.backupRcloneStatus = await this.api('/backups/rclone/status');
                },
                async installBackupRclone() {
                    this.backupRcloneInstalling = true;
                    this.backupError = '';
                    this.backupSuccess = '';
                    try {
                        await this.api('/backups/rclone/install', 'POST');
                        const startedAt = Date.now();
                        while (Date.now() - startedAt < 5 * 60 * 1000) {
                            await new Promise(resolve => setTimeout(resolve, 2000));
                            await this.loadBackupRcloneStatus();
                            if ((this.backupRcloneStatus?.status || '') !== 'installing') break;
                        }
                        if ((this.backupRcloneStatus?.status || '') === 'available') {
                            this.backupSuccess = this.backupRcloneStatus?.message || 'rclone installed successfully.';
                        } else if ((this.backupRcloneStatus?.status || '') === 'failed') {
                            this.backupError = this.backupRcloneStatus?.message || 'Failed to install rclone.';
                        } else {
                            this.backupError = 'rclone install did not finish yet. Please check status again.';
                        }
                    } catch (e) {
                        this.backupError = e.message || 'Failed to install rclone';
                    } finally {
                        this.backupRcloneInstalling = false;
                    }
                },
                buildBackupPayloadForSave() {
                    const repository = this.buildBackupRepositoryFromForm();
                    return {
                        backend_type: (this.backupForm.backend_type || '').trim(),
                        repository,
                        repository_password: (this.backupForm.repository_password || '').trim(),
                        sftp_username: (this.backupForm.sftp_username || '').trim(),
                        sftp_host: (this.backupForm.sftp_host || '').trim(),
                        sftp_port: Math.max(1, parseInt(this.backupForm.sftp_port || 22, 10) || 22),
                        sftp_path: this.normalizeAbsolutePath(this.backupForm.sftp_path || ''),
                        s3_endpoint: (this.backupForm.s3_endpoint || '').trim().replace(/\/+$/, ''),
                        s3_bucket: (this.backupForm.s3_bucket || '').trim(),
                        s3_prefix: (this.backupForm.s3_prefix || '').trim(),
                        s3_region: (this.backupForm.s3_region || '').trim(),
                        s3_bucket_lookup: (this.backupForm.s3_bucket_lookup || 'auto').trim().toLowerCase(),
                        s3_list_objects_v1: !!this.backupForm.s3_list_objects_v1,
                        s3_access_key_id: (this.backupForm.s3_access_key_id || '').trim(),
                        s3_secret_access_key: (this.backupForm.s3_secret_access_key || '').trim(),
                        s3_session_token: (this.backupForm.s3_session_token || '').trim(),
                        enabled: !!this.backupForm.enabled,
                        schedule_cron: (this.backupForm.schedule_cron || '').trim(),
                        exclude_site_ids: this.backupForm.exclude_site_ids || [],
                        exclude_database_ids: this.backupForm.exclude_database_ids || [],
                        keep_last: Math.max(0, parseInt(this.backupForm.keep_last || 0, 10) || 0),
                        keep_daily: Math.max(0, parseInt(this.backupForm.keep_daily || 0, 10) || 0),
                        keep_weekly: Math.max(0, parseInt(this.backupForm.keep_weekly || 0, 10) || 0),
                        keep_monthly: Math.max(0, parseInt(this.backupForm.keep_monthly || 0, 10) || 0)
                    };
                },
                async testBackupConfig() {
                    this.backupTesting = true;
                    this.backupError = '';
                    this.backupSuccess = '';
                    try {
                        const payload = this.buildBackupPayloadForSave();
                        const result = await this.api('/backups/config/test', 'POST', payload);
                        this.backupSuccess = result?.message || 'Backup backend connection is valid.';
                    } catch (e) {
                        this.backupError = e.message || 'Failed to validate backup backend';
                    } finally {
                        this.backupTesting = false;
                    }
                },
                async saveBackupConfig() {
                    this.backupSaving = true;
                    this.backupError = '';
                    this.backupSuccess = '';
                    try {
                        const payload = this.buildBackupPayloadForSave();
                        if (payload.enabled || payload.backend_type === 'rclone') {
                            await this.api('/backups/config/test', 'POST', payload);
                        }
                        this.backupConfig = await this.api('/backups/config', 'PUT', payload);
                        this.backupForm.repository_password = '';
                        this.backupForm.s3_access_key_id = '';
                        this.backupForm.s3_secret_access_key = '';
                        this.backupForm.s3_session_token = '';
                        this.backupForm.repository = payload.repository;
                        this.backupSuccess = 'Backup settings saved.';
                    } catch (e) {
                        this.backupError = e.message || 'Failed to save backup settings';
                    } finally {
                        this.backupSaving = false;
                    }
                },
                async runBackupNow() {
                    this.backupRunningNow = true;
                    this.backupError = '';
                    this.backupSuccess = '';
                    try {
                        const result = await this.api('/backups/run', 'POST');
                        this.backupSuccess = result?.message || 'Backup job started.';
                        await this.loadBackupJobs();
                        await this.loadBackupConfig();
                    } catch (e) {
                        this.backupError = e.message || 'Failed to start backup';
                    } finally {
                        this.backupRunningNow = false;
                    }
                },
                async loadBackupJobs() {
                    this.backupJobs = await this.api('/backups/jobs?limit=50') || [];
                },
                async loadBackupSnapshots() {
                    this.backupSnapshots = await this.api('/backups/snapshots?limit=40') || [];
                },
                extractDownloadFilenameFromHeader(contentDisposition, fallbackName = 'snapshot.zip') {
                    const value = (contentDisposition || '').trim();
                    if (!value) return fallbackName;
                    const utfMatch = value.match(/filename\*=UTF-8''([^;]+)/i);
                    if (utfMatch && utfMatch[1]) {
                        try {
                            return decodeURIComponent(utfMatch[1]);
                        } catch (_e) {}
                    }
                    const basicMatch = value.match(/filename="?([^";]+)"?/i);
                    if (basicMatch && basicMatch[1]) return basicMatch[1];
                    return fallbackName;
                },
                async downloadSelectedBackupSnapshot(snapshotID = '') {
                    this.backupError = '';
                    this.backupSuccess = '';
                    if (!snapshotID) {
                        this.backupError = 'No snapshot specified.';
                        return;
                    }
                    const targetSnapshotID = snapshotID;
                    this.backupSnapshotDownloading = true;
                    try {
                        const resp = await fetch(`${API}/backups/snapshots/${encodeURIComponent(targetSnapshotID)}/download`, {
                            method: 'GET',
                            headers: { 'Authorization': `Bearer ${this.token}` }
                        });
                        if (resp.status === 401) {
                            this.logout();
                            throw new Error('Session expired');
                        }
                        if (!resp.ok) {
                            let message = 'Failed to download snapshot zip';
                            try {
                                const errData = await resp.json();
                                message = errData?.error || message;
                            } catch (_e) {}
                            throw new Error(message);
                        }
                        const fileName = this.extractDownloadFilenameFromHeader(
                            resp.headers.get('content-disposition'),
                            `snapshot-${(targetSnapshotID || '').slice(0, 8) || 'download'}.zip`
                        );
                        const blob = await resp.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = fileName;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        window.URL.revokeObjectURL(url);
                        this.backupSuccess = 'Snapshot ZIP download started.';
                    } catch (e) {
                        this.backupError = e.message || 'Failed to download snapshot zip';
                    } finally {
                        this.backupSnapshotDownloading = false;
                    }
                },
                async deleteSelectedBackupSnapshot(snapshotID = '') {
                    this.backupError = '';
                    this.backupSuccess = '';
                    if (!snapshotID) {
                        this.backupError = 'No snapshot specified.';
                        return;
                    }
                    const targetSnapshotID = snapshotID;
                    if (!confirm('Delete this snapshot? This action cannot be undone.')) {
                        return;
                    }
                    this.backupSnapshotDeleting = true;
                    try {
                        const result = await this.api('/backups/snapshots/delete', 'POST', {
                            snapshot_id: targetSnapshotID
                        });
                        this.backupSuccess = result?.message || 'Snapshot delete job started.';
                        await Promise.all([this.loadBackupJobs(), this.loadBackupSnapshots()]);
                    } catch (e) {
                        this.backupError = e.message || 'Failed to delete snapshot';
                    } finally {
                        this.backupSnapshotDeleting = false;
                    }
                },
                snapshotTagValuesFor(snapshot, prefix) {
                    if (!snapshot || !Array.isArray(snapshot.tags)) return [];
                    const values = [];
                    for (const tag of snapshot.tags) {
                        const text = (tag || '').toString();
                        if (text.startsWith(prefix)) {
                            values.push(text.slice(prefix.length).trim());
                        }
                    }
                    return [...new Set(values.filter(Boolean))];
                },
                snapshotSiteDomainValues(snapshot) {
                    return this.snapshotTagValuesFor(snapshot, 'site-domain:').map(v => v.toLowerCase());
                },
                snapshotDatabaseNameValues(snapshot) {
                    return this.snapshotTagValuesFor(snapshot, 'db-name:').map(v => v.toLowerCase());
                },
                snapshotTypeLabel(snapshot) {
                    const siteCount = this.snapshotSiteDomainValues(snapshot).length;
                    const dbCount = this.snapshotDatabaseNameValues(snapshot).length;
                    if (siteCount > 0 && dbCount > 0) return 'Website + Database';
                    if (siteCount > 0) return 'Website';
                    if (dbCount > 0) return 'Database';
                    return 'Legacy/Unknown';
                },
                snapshotTypeBadgeClass(snapshot) {
                    const label = this.snapshotTypeLabel(snapshot);
                    if (label === 'Website + Database') return 'bg-indigo-100 text-indigo-700';
                    if (label === 'Website') return 'bg-blue-100 text-blue-700';
                    if (label === 'Database') return 'bg-emerald-100 text-emerald-700';
                    return 'bg-gray-100 text-gray-600';
                },
                snapshotFilterSelectedSiteDomain() {
                    const sites = Array.isArray(this.backupConfig?.catalog?.sites) ? this.backupConfig.catalog.sites : [];
                    const selected = sites.find((s) => s.id === this.backupRestoreFilterSiteID);
                    return selected ? ((selected.domain || '').toString().trim().toLowerCase()) : '';
                },
                snapshotFilterSelectedDatabaseName() {
                    const dbs = Array.isArray(this.backupConfig?.catalog?.databases) ? this.backupConfig.catalog.databases : [];
                    const selected = dbs.find((d) => d.id === this.backupRestoreFilterDatabaseID);
                    return selected ? ((selected.db_name || '').toString().trim().toLowerCase()) : '';
                },
                filteredBackupSnapshotsTable() {
                    const snapshots = Array.isArray(this.backupSnapshots) ? [...this.backupSnapshots] : [];
                    const type = this.backupRestoreFilterType;
                    const selectedDomain = this.snapshotFilterSelectedSiteDomain();
                    const selectedDB = this.snapshotFilterSelectedDatabaseName();
                    const filtered = snapshots.filter((snap) => {
                        const siteDomains = this.snapshotSiteDomainValues(snap);
                        const dbNames = this.snapshotDatabaseNameValues(snap);
                        if (type === 'site') {
                            if (selectedDomain) return siteDomains.includes(selectedDomain);
                            return siteDomains.length > 0;
                        }
                        if (type === 'database') {
                            if (selectedDB) return dbNames.includes(selectedDB);
                            return dbNames.length > 0;
                        }
                        return true;
                    });
                    filtered.sort((a, b) => new Date(b?.time || 0).getTime() - new Date(a?.time || 0).getTime());
                    return filtered;
                },
                normalizeAbsolutePath(v) {
                    let value = (v || '').trim();
                    if (!value) return '';
                    value = value.replace(/\/+/g, '/');
                    if (!value.startsWith('/')) value = '/' + value;
                    return value;
                },
                normalizeS3Endpoint(v) {
                    let value = (v || '').trim();
                    if (!value) return '';
                    return value.replace(/\/+$/, '');
                },
                formatSFTPHostForURL(host) {
                    const value = (host || '').trim();
                    if (!value) return '';
                    if (value.includes(':') && !(value.startsWith('[') && value.endsWith(']'))) {
                        return `[${value}]`;
                    }
                    return value;
                },
                buildBackupRepositoryFromForm() {
                    const backendType = (this.backupForm.backend_type || '').trim();
                    if (backendType === 'local') {
                        const path = this.normalizeAbsolutePath(this.backupForm.local_path);
                        if (!path) throw new Error('Local backup path is required.');
                        return path;
                    }
                    if (backendType === 'rclone') {
                        const repo = (this.backupForm.rclone_repository || '').trim();
                        if (!repo) throw new Error('Rclone repository is required.');
                        if (!/^rclone:/i.test(repo)) throw new Error('Rclone repository must start with rclone:.');
                        return repo;
                    }
                    if (backendType === 's3') {
                        const endpoint = this.normalizeS3Endpoint(this.backupForm.s3_endpoint);
                        const bucket = (this.backupForm.s3_bucket || '').trim().replace(/^\/+|\/+$/g, '');
                        const prefix = (this.backupForm.s3_prefix || '').trim().replace(/^\/+|\/+$/g, '');
                        if (!endpoint) throw new Error('S3 endpoint is required.');
                        if (!bucket) throw new Error('S3 bucket is required.');
                        return `s3:${endpoint}/${bucket}${prefix ? `/${prefix}` : ''}`;
                    }
                    const username = (this.backupForm.sftp_username || '').trim();
                    const host = (this.backupForm.sftp_host || '').trim();
                    const port = Math.max(1, parseInt(this.backupForm.sftp_port || 22, 10) || 22);
                    const path = this.normalizeAbsolutePath(this.backupForm.sftp_path);
                    if (!username) throw new Error('SFTP username is required.');
                    if (!host) throw new Error('SFTP host is required.');
                    if (!port || port > 65535) throw new Error('SFTP port must be between 1 and 65535.');
                    if (!path) throw new Error('SFTP path is required.');
                    const hostForURL = this.formatSFTPHostForURL(host);
                    const pathSuffix = path.replace(/^\/+/, '');
                    return `sftp://${encodeURIComponent(username)}@${hostForURL}:${port}//${pathSuffix}`;
                },
                backupRepositoryPreview() {
                    try {
                        return this.buildBackupRepositoryFromForm();
                    } catch (_e) {
                        return '';
                    }
                },
                snapshotSizeBytes(snapshot) {
                    const fromSummary = Number(snapshot?.summary?.total_size);
                    if (Number.isFinite(fromSummary) && fromSummary >= 0) return fromSummary;
                    const direct = Number(snapshot?.total_size);
                    if (Number.isFinite(direct) && direct >= 0) return direct;
                    return null;
                },
                snapshotSizeLabel(snapshot) {
                    const bytes = this.snapshotSizeBytes(snapshot);
                    if (bytes === null) return 'Size: Unknown';
                    if (bytes === 0) return 'Size: 0 B';
                    return `Size: ${this.formatBytes(bytes)}`;
                },
                snapshotContentsSummary(snapshot) {
                    const sc = this.snapshotSiteDomainValues(snapshot).length;
                    const dc = this.snapshotDatabaseNameValues(snapshot).length;
                    const parts = [];
                    if (sc > 0) parts.push(`${sc} website${sc !== 1 ? 's' : ''}`);
                    if (dc > 0) parts.push(`${dc} database${dc !== 1 ? 's' : ''}`);
                    return parts.join(', ') || '';
                },
                snapshotRestoreSiteByDomain(snapshot, domain) {
                    const sites = Array.isArray(this.backupConfig?.catalog?.sites) ? this.backupConfig.catalog.sites : [];
                    return sites.find((s) => (s.domain || '').toString().trim().toLowerCase() === domain) || null;
                },
                snapshotRestoreDBByName(snapshot, dbName) {
                    const dbs = Array.isArray(this.backupConfig?.catalog?.databases) ? this.backupConfig.catalog.databases : [];
                    return dbs.find((d) => (d.db_name || '').toString().trim().toLowerCase() === dbName) || null;
                },
                async restoreSiteFromSnapshot(siteID = '', snapshotID = '') {
                    this.backupError = '';
                    this.backupSuccess = '';
                    const targetSnapshotID = snapshotID;
                    const targetSiteID = siteID;
                    if (!targetSnapshotID || !targetSiteID) {
                        this.backupError = 'Select a snapshot and website first.';
                        return;
                    }
                    this.restoreLoading = true;
                    try {
                        const result = await this.api('/backups/restore/site', 'POST', {
                            snapshot_id: targetSnapshotID,
                            site_id: targetSiteID
                        });
                        this.backupSuccess = result?.message || 'Website restore started.';
                        await this.loadBackupJobs();
                    } catch (e) {
                        this.backupError = e.message || 'Failed to restore website';
                    } finally {
                        this.restoreLoading = false;
                    }
                },
                async restoreDatabaseFromSnapshot(databaseID = '', snapshotID = '') {
                    this.backupError = '';
                    this.backupSuccess = '';
                    const targetSnapshotID = snapshotID;
                    const targetDatabaseID = databaseID;
                    if (!targetSnapshotID || !targetDatabaseID) {
                        this.backupError = 'Select a snapshot and database first.';
                        return;
                    }
                    this.restoreLoading = true;
                    try {
                        const result = await this.api('/backups/restore/database', 'POST', {
                            snapshot_id: targetSnapshotID,
                            database_id: targetDatabaseID
                        });
                        this.backupSuccess = result?.message || 'Database restore started.';
                        await this.loadBackupJobs();
                    } catch (e) {
                        this.backupError = e.message || 'Failed to restore database';
                    } finally {
                        this.restoreLoading = false;
                    }
                },
                async loadSSHKeys() { this.sshKeys = await this.api('/ssh-keys') || []; },
                async loadCronJobs() { this.cronJobs = await this.api('/cron') || []; },
                async loadSystemStatus() {
                    this.systemStatus = await this.api('/system/status');
                    const systemDefault = this.systemStatus?.php_version;
                    if (!this.phpDefaultConfig?.default_php_version && systemDefault && ['8.2', '8.3', '8.4', '8.5'].includes(systemDefault)) {
                        this.newSite.php_version = systemDefault;
                    }
                },
                async loadPublicIP() {
                    if (this.publicIPLoaded) return;
                    this.publicIPLoaded = true;
                    const host = (window.location.hostname || '').trim();
                    if (host && host !== 'localhost' && host !== '127.0.0.1' && host !== '::1') {
                        this.publicIP = host;
                        return;
                    }
                    const sysHost = (this.systemStatus?.hostname || '').trim();
                    if (sysHost && sysHost !== 'localhost') {
                        this.publicIP = sysHost;
                    }
                },
                sftpHost() {
                    return this.publicIP || window.location.hostname || this.systemStatus?.hostname || '-';
                },
                getAvailablePHPVersions() {
                    const fromDefault = (this.phpDefaultConfig?.available_php_versions || []).map(v => (v || '').trim()).filter(Boolean);
                    if (fromDefault.length > 0) return fromDefault;
                    const fromStatus = (this.systemStatus?.php_available_versions || []).map(v => (v || '').trim()).filter(Boolean);
                    if (fromStatus.length > 0) return fromStatus;
                    return ['8.4'];
                },
                async refreshAvailablePHPVersions() {
                    // Refresh shared PHP version sources so dropdowns are always current.
                    await this.loadSystemStatus();
                    if (this.user?.is_admin) {
                        await this.loadPHPDefaultConfig();
                    }
                },
                async loadMySQLConfig() {
                    this.mysqlConfigLoading = true;
                    this.mysqlConfigError = '';
                    try {
                        this.mysqlConfig = await this.api('/system/mysql-config');
                    } catch (e) {
                        this.mysqlConfigError = 'Failed to load MySQL config';
                    }
                    this.mysqlConfigLoading = false;
                },
                async loadPHPDefaultConfig() {
                    this.phpDefaultConfigLoading = true;
                    this.phpDefaultConfigError = '';
                    try {
                        this.phpDefaultConfig = await this.api('/system/php-default-config');
                        const rawOptions = this.phpDefaultConfig?.available_php_versions || [];
                        const options = [...new Set(rawOptions.map(v => (v || '').toString().trim()).filter(Boolean))];
                        const selected = (this.phpDefaultConfig?.default_php_version || '').toString().trim();
                        // Preserve configured selection even if it is temporarily missing in available list.
                        if (selected && !options.includes(selected)) {
                            options.unshift(selected);
                        }
                        this.phpDefaultConfig.available_php_versions = options;
                        if (selected) {
                            this.phpDefaultConfig.default_php_version = selected;
                        } else if (options.length > 0) {
                            this.phpDefaultConfig.default_php_version = options[0];
                        }
                        if (this.phpDefaultConfig.default_php_version) {
                            this.newSite.php_version = this.phpDefaultConfig.default_php_version;
                        }
                    } catch (e) {
                        this.phpDefaultConfigError = e.message || 'Failed to load default PHP version';
                    }
                    this.phpDefaultConfigLoading = false;
                },
                isPHPVersionInstalled(version) {
                    const installed = (this.phpDefaultConfig?.available_php_versions || []).map(v => (v || '').toString().trim());
                    return installed.includes((version || '').toString().trim());
                },
                async installPHPVersion(version) {
                    const v = (version || '').toString().trim();
                    if (!v || this.isPHPVersionInstalled(v)) return;
                    this.phpVersionInstalling = { ...this.phpVersionInstalling, [v]: true };
                    this.phpDefaultConfigError = '';
                    this.phpDefaultConfigSuccess = '';
                    try {
                        await this.api('/system/php/install-version', 'POST', { version: v });
                        this.phpDefaultConfigSuccess = `Installing PHP ${v} in background...`;
                        let finalStatus = null;
                        for (let attempt = 0; attempt < 360; attempt++) {
                            await this.sleep(2000);
                            const status = await this.api(`/system/php/install-version-status?version=${encodeURIComponent(v)}`);
                            if (!status || status.status === 'idle' || status.status === 'running') {
                                continue;
                            }
                            finalStatus = status;
                            break;
                        }
                        if (!finalStatus) {
                            throw new Error(`PHP ${v} installation is still running. Please check again in a moment.`);
                        }
                        if (finalStatus.status === 'failed') {
                            throw new Error(finalStatus.message || `Failed to install PHP ${v}`);
                        }
                        this.phpDefaultConfigSuccess = finalStatus.message || `PHP ${v} installed successfully.`;
                        await this.loadPHPDefaultConfig();
                        await this.loadSystemStatus();
                    } catch (e) {
                        this.phpDefaultConfigError = e.message || `Failed to install PHP ${v}`;
                    } finally {
                        this.phpVersionInstalling = { ...this.phpVersionInstalling, [v]: false };
                    }
                },
                async savePHPDefaultConfig() {
                    this.phpDefaultConfigSaving = true;
                    this.phpDefaultConfigError = '';
                    this.phpDefaultConfigSuccess = '';
                    try {
                        if (!this.phpDefaultConfig?.default_php_version) {
                            throw new Error('Please select a default PHP version');
                        }
                        const selected = (this.phpDefaultConfig.default_php_version || '').toString().trim();
                        const options = (this.phpDefaultConfig.available_php_versions || []).map(v => (v || '').toString().trim()).filter(Boolean);
                        if (options.length > 0 && !options.includes(selected)) {
                            throw new Error('Selected PHP version is not available on this server');
                        }
                        await this.api('/system/php-default-config', 'PUT', {
                            default_php_version: selected
                        });
                        this.phpDefaultConfig.default_php_version = selected;
                        this.phpDefaultConfigSuccess = 'Default PHP version updated.';
                        setTimeout(() => this.phpDefaultConfigSuccess = '', 5000);
                        await this.loadPHPDefaultConfig();
                        await this.loadSystemStatus();
                    } catch (e) {
                        this.phpDefaultConfigError = e.message || 'Failed to save default PHP version';
                    }
                    this.phpDefaultConfigSaving = false;
                },
                async saveMySQLConfig() {
                    this.mysqlConfigSaving = true;
                    this.mysqlConfigError = '';
                    this.mysqlConfigSuccess = '';
                    try {
                        await this.api('/system/mysql-config', 'PUT', {
                            buffer_pool_mb: parseInt(this.mysqlConfig.buffer_pool_mb, 10),
                            max_connections: parseInt(this.mysqlConfig.max_connections, 10),
                            perf_schema: this.mysqlConfig.perf_schema
                        });
                        this.mysqlConfigSuccess = 'MySQL configuration updated and service restarted.';
                        setTimeout(() => this.mysqlConfigSuccess = '', 5000);
                    } catch (e) {
                        this.mysqlConfigError = e.message || 'Failed to save MySQL config';
                    }
                    this.mysqlConfigSaving = false;
                },
                async loadCaddyConfig() {
                    this.caddyConfigLoading = true;
                    this.caddyConfigError = '';
                    try {
                        this.caddyConfig = await this.api('/system/caddy-config');
                    } catch (e) {
                        this.caddyConfigError = e.message || 'Failed to load Caddy config';
                    }
                    this.caddyConfigLoading = false;
                },
                async saveCaddyConfig() {
                    this.caddyConfigSaving = true;
                    this.caddyConfigError = '';
                    this.caddyConfigSuccess = '';
                    try {
                        if (!this.caddyConfig) throw new Error('Caddy config is not loaded');
                        await this.api('/system/caddy-config', 'PUT', {
                            profile: this.caddyConfig.profile,
                            access_logs: !!this.caddyConfig.access_logs,
                            expert_mode: !!this.caddyConfig.expert_mode,
                            read_header: this.caddyConfig.read_header,
                            read_body: this.caddyConfig.read_body,
                            write_timeout: this.caddyConfig.write_timeout,
                            idle_timeout: this.caddyConfig.idle_timeout,
                            grace_period: this.caddyConfig.grace_period,
                            max_header_size: parseInt(this.caddyConfig.max_header_size, 10)
                        });
                        this.caddyConfigSuccess = 'Caddy performance settings updated and reloaded.';
                        setTimeout(() => this.caddyConfigSuccess = '', 5000);
                        await this.loadCaddyConfig();
                    } catch (e) {
                        this.caddyConfigError = e.message || 'Failed to save Caddy config';
                    }
                    this.caddyConfigSaving = false;
                },
                async loadFirewallStatus() {
                    this.firewallLoading = true;
                    this.firewallError = '';
                    try {
                        this.firewallStatus = await this.api('/system/firewall');
                    } catch (e) {
                        this.firewallError = e.message || 'Failed to load firewall status';
                    }
                    this.firewallLoading = false;
                },
                async installFirewall() {
                    this.firewallInstalling = true;
                    this.firewallError = '';
                    this.firewallSuccess = '';
                    try {
                        await this.api('/system/firewall/install', 'POST');
                        this.firewallSuccess = 'UFW installed successfully.';
                        await this.loadFirewallStatus();
                    } catch (e) {
                        this.firewallError = e.message || 'Failed to install firewall';
                    }
                    this.firewallInstalling = false;
                },
                async setFirewallEnabled(enabled) {
                    this.firewallSaving = true;
                    this.firewallError = '';
                    this.firewallSuccess = '';
                    try {
                        await this.api('/system/firewall/enabled', 'PUT', { enabled: !!enabled });
                        this.firewallSuccess = `Firewall ${enabled ? 'enabled' : 'disabled'}.`;
                        await this.loadFirewallStatus();
                    } catch (e) {
                        this.firewallError = e.message || 'Failed to update firewall state';
                    }
                    this.firewallSaving = false;
                },
                async firewallAllowPort() {
                    const port = parseInt(this.firewallRuleForm.port, 10);
                    if (!port || port < 1 || port > 65535) {
                        this.firewallError = 'Port must be between 1 and 65535.';
                        return;
                    }
                    this.firewallSaving = true;
                    this.firewallError = '';
                    this.firewallSuccess = '';
                    try {
                        await this.api('/system/firewall/allow', 'POST', {
                            port,
                            protocol: this.firewallRuleForm.protocol || 'tcp',
                            ip_version: this.firewallRuleForm.ip_version || 'both'
                        });
                        this.firewallSuccess = `Allowed ${port}/${this.firewallRuleForm.protocol || 'tcp'} (${this.firewallRuleForm.ip_version || 'both'}).`;
                        this.firewallRuleForm.port = null;
                        await this.loadFirewallStatus();
                    } catch (e) {
                        this.firewallError = e.message || 'Failed to allow port';
                    }
                    this.firewallSaving = false;
                },
                async firewallDenyPort() {
                    const port = parseInt(this.firewallRuleForm.port, 10);
                    if (!port || port < 1 || port > 65535) {
                        this.firewallError = 'Port must be between 1 and 65535.';
                        return;
                    }
                    if (port === (this.firewallStatus?.control_panel_port || 2050)) {
                        this.firewallError = `Port ${port} is reserved for the control panel and cannot be blocked.`;
                        return;
                    }
                    this.firewallSaving = true;
                    this.firewallError = '';
                    this.firewallSuccess = '';
                    try {
                        await this.api('/system/firewall/deny', 'POST', {
                            port,
                            protocol: this.firewallRuleForm.protocol || 'tcp',
                            ip_version: this.firewallRuleForm.ip_version || 'both'
                        });
                        this.firewallSuccess = `Blocked ${port}/${this.firewallRuleForm.protocol || 'tcp'} (${this.firewallRuleForm.ip_version || 'both'}).`;
                        this.firewallRuleForm.port = null;
                        await this.loadFirewallStatus();
                    } catch (e) {
                        this.firewallError = e.message || 'Failed to block port';
                    }
                    this.firewallSaving = false;
                },
                async firewallDeleteRule(rule) {
                    const value = (rule?.rule || '').toLowerCase();
                    const controlPanel = (this.firewallStatus?.control_panel_port || 2050).toString() + '/';
                    if (value.startsWith(controlPanel)) {
                        this.firewallError = `Rule for control panel port ${this.firewallStatus?.control_panel_port || 2050} cannot be removed.`;
                        return;
                    }
                    const match = value.match(/^(\d+)\/(tcp|udp)/);
                    if (!match) {
                        this.firewallError = 'Only numeric port rules can be removed from the panel right now.';
                        return;
                    }
                    this.firewallSaving = true;
                    this.firewallError = '';
                    this.firewallSuccess = '';
                    try {
                        await this.api('/system/firewall/delete', 'POST', {
                            port: parseInt(match[1], 10),
                            protocol: match[2],
                            ip_version: rule.ip_version || ((rule.rule || '').toLowerCase().includes('(v6)') ? 'ipv6' : 'ipv4')
                        });
                        this.firewallSuccess = `Removed rule ${match[1]}/${match[2]}.`;
                        await this.loadFirewallStatus();
                    } catch (e) {
                        this.firewallError = e.message || 'Failed to remove rule';
                    }
                    this.firewallSaving = false;
                },
                async loadSSHConfig() {
                    this.sshConfigLoading = true;
                    this.sshConfigError = '';
                    try {
                        this.sshConfig = await this.api('/system/ssh-config');
                        this.sshConnectionPort = this.sshConfig?.port || 22;
                    } catch (e) {
                        this.sshConfigError = 'Failed to load SSH config';
                    }
                    this.sshConfigLoading = false;
                },
                async saveSSHConfig() {
                    this.sshConfigSaving = true;
                    this.sshConfigError = '';
                    this.sshConfigSuccess = '';
                    try {
                        const currentPort = parseInt(this.sshConfig.port, 10);
                        if (!currentPort || currentPort < 1 || currentPort > 65535) {
                            throw new Error('SSH port must be between 1 and 65535');
                        }
                        await this.api('/system/ssh-config', 'PUT', {
                            port: currentPort,
                            password_auth: !!this.sshConfig.password_auth
                        });
                        this.sshConnectionPort = currentPort;
                        this.sshConfigSuccess = 'SSH configuration updated and service reloaded.';
                        setTimeout(() => this.sshConfigSuccess = '', 5000);
                    } catch (e) {
                        this.sshConfigError = e.message || 'Failed to save SSH config';
                    }
                    this.sshConfigSaving = false;
                },
                async loadUsers() { 
                    try { this.users = await this.api('/users') || []; } 
                    catch(e) { this.users = []; }
                },

                async createSite() {
                    this.creatingSite = true;
                    this.siteCreationError = '';
                    
                    const isWordPress = this.newSite.site_type === 'wordpress';
                    
                    try {
                        if (isWordPress) {
                            this.siteCreationStatus = 'Creating site directory...';
                            await this.sleep(500);
                            this.siteCreationStatus = 'Setting up database...';
                            await this.sleep(500);
                            this.siteCreationStatus = 'Downloading WordPress...';
                        } else {
                            this.siteCreationStatus = 'Creating site...';
                        }
                        
                        await this.api('/sites', 'POST', this.newSite);
                        
                        if (isWordPress) {
                            this.siteCreationStatus = 'Finalizing installation...';
                            await this.sleep(300);
                        }
                        
                        this.creatingSite = false;
                        this.showCreateSite = false;
                        this.siteCreationStatus = '';
                        this.newSite = {
                            domain: '',
                            slug: '',
                            site_type: 'php',
                            php_version: this.phpDefaultConfig?.default_php_version || this.systemStatus?.php_version || '8.4'
                        };
                        this.resetSiteValidation();
                        this.loadSites();
                        this.loadDatabases();
                    } catch (e) {
                        this.creatingSite = false;
                        this.siteCreationStatus = '';
                        this.siteCreationError = e.message || 'Failed to create site';
                    }
                },

                sleep(ms) {
                    return new Promise(resolve => setTimeout(resolve, ms));
                },

                validateDomainAndGenerateSlug() {
                    // Normalize domain: lowercase and trim
                    this.newSite.domain = this.newSite.domain.toLowerCase().replace(/\s+/g, '');
                    this.validateDomain();
                    this.generateSlugFromDomain();
                },

                async validateDomain() {
                    clearTimeout(this.domainValidateTimeout);
                    const domain = this.newSite.domain.trim();
                    if (!domain) {
                        this.domainValidation = { valid: null, message: '' };
                        return;
                    }

                    this.domainValidateTimeout = setTimeout(async () => {
                        try {
                            const result = await this.api('/sites/validate-domain', 'POST', { domain });
                            this.domainValidation = { valid: result.valid, message: result.message };
                        } catch (e) {
                            this.domainValidation = { valid: false, message: e.message || 'Validation failed' };
                        }
                    }, 300);
                },

                async generateSlugFromDomain() {
                    const domain = this.newSite.domain.trim();
                    if (!domain) {
                        this.newSite.slug = '';
                        this.resetSlugValidation();
                        return;
                    }
                    
                    try {
                        const result = await this.api('/sites/generate-slug', 'POST', { domain });
                        this.newSite.slug = result.slug;
                        this.validateSlug();
                    } catch (e) {
                        this.newSite.slug = domain.replace(/\./g, '_').replace(/-/g, '_');
                        this.validateSlug();
                    }
                },

                async validateSlug() {
                    clearTimeout(this.slugValidateTimeout);
                    const slug = this.newSite.slug.trim();
                    if (!slug) {
                        this.slugValidation = { valid: null, message: '' };
                        return;
                    }

                    this.slugValidateTimeout = setTimeout(async () => {
                        try {
                            const result = await this.api('/sites/validate-slug', 'POST', { slug });
                            this.slugValidation = {
                                valid: result.valid,
                                message: result.message
                            };
                        } catch (e) {
                            this.slugValidation = { valid: false, message: 'Validation failed' };
                        }
                    }, 300);
                },

                resetSlugValidation() {
                    this.slugValidation = { valid: null, message: '' };
                },

                resetSiteValidation() {
                    this.domainValidation = { valid: null, message: '' };
                    this.slugValidation = { valid: null, message: '' };
                },

                askConfirmation({ title, message, confirmText = 'Delete' }) {
                    return new Promise((resolve) => {
                        this.confirmModalTitle = title || 'Confirm Action';
                        this.confirmModalMessage = message || '';
                        this.confirmModalConfirmText = confirmText;
                        this.confirmModalResolver = resolve;
                        this.showConfirmModal = true;
                    });
                },

                cancelConfirmation() {
                    this.showConfirmModal = false;
                    if (this.confirmModalResolver) {
                        this.confirmModalResolver(false);
                        this.confirmModalResolver = null;
                    }
                },

                acceptConfirmation() {
                    this.showConfirmModal = false;
                    if (this.confirmModalResolver) {
                        this.confirmModalResolver(true);
                        this.confirmModalResolver = null;
                    }
                },

                async deleteSite(site) {
                    const confirmed = await this.askConfirmation({
                        title: 'Delete Site',
                        message: `Delete ${site.domain}? This cannot be undone.`,
                        confirmText: 'Delete Site'
                    });
                    if (!confirmed) return;
                    this.deletingSiteId = site.id;
                    try {
                        await this.api(`/sites/${site.id}`, 'DELETE');
                        await this.loadSites();
                    } catch (e) {
                        alert('Failed to delete site: ' + (e.message || 'Unknown error'));
                    } finally {
                        this.deletingSiteId = null;
                    }
                },

                // Pagination helpers
                sitesTotalPages() { return Math.ceil(this.sitesTotal / this.sitesLimit) || 1; },
                databasesTotalPages() { return Math.ceil(this.databasesTotal / this.databasesLimit) || 1; },
                
                searchSites() {
                    this.sitesPage = 1;
                    this.loadSites();
                },
                searchDatabases() {
                    this.databasesPage = 1;
                    this.loadDatabases();
                },
                goToSitesPage(page) {
                    this.sitesPage = page;
                    this.loadSites();
                },
                goToDatabasesPage(page) {
                    this.databasesPage = page;
                    this.loadDatabases();
                },

                async openCreateSiteModal() {
                    await this.refreshAvailablePHPVersions();
                    const phpOptions = this.getAvailablePHPVersions();
                    const current = (this.newSite?.php_version || '').toString().trim();
                    const preferred = (this.phpDefaultConfig?.default_php_version || '').toString().trim();
                    this.newSite.php_version = phpOptions.includes(current)
                        ? current
                        : (phpOptions.includes(preferred) ? preferred : (phpOptions[0] || '8.4'));
                    this.showCreateSite = true;
                },

                async openSiteSettings(site) {
                    this.managingSite = site;
                    this.siteSettingsTab = 'general';
                    this.newDomain = { domain: '', redirect_to_primary: false };
                    this.domainError = '';
                    this.siteSettingsError = '';
                    this.siteSettingsSuccess = '';
                    await this.refreshAvailablePHPVersions();
                    this.siteSettingsForm = {
                        force_https: site.force_https !== false,
                        compression_enabled: site.compression_enabled !== false,
                        gzip_enabled: site.gzip_enabled !== false,
                        zstd_enabled: site.zstd_enabled !== false,
                        cache_control_enabled: site.cache_control_enabled === true,
                        cache_control_value: site.cache_control_value || '',
                        php_version: site.php_version || '8.4',
                        php_memory_limit: site.php_memory_limit || '256M',
                        php_post_max_size: site.php_post_max_size || '64M',
                        php_upload_max_filesize: site.php_upload_max_filesize || '64M',
                        php_max_execution_time: Number.isFinite(site.php_max_execution_time) ? site.php_max_execution_time : 300,
                        php_max_input_vars: Number.isFinite(site.php_max_input_vars) ? site.php_max_input_vars : 5000
                    };
                    const phpOptions = this.getAvailablePHPVersions();
                    if (!phpOptions.includes(this.siteSettingsForm.php_version)) {
                        this.siteSettingsForm.php_version = phpOptions[0];
                    }
                    this.navigate('site-settings');
                },

                onCompressionToggleChanged() {
                    if (this.siteSettingsForm.compression_enabled && !this.siteSettingsForm.gzip_enabled && !this.siteSettingsForm.zstd_enabled) {
                        this.siteSettingsForm.gzip_enabled = true;
                    }
                    if (!this.siteSettingsForm.compression_enabled) {
                        this.siteSettingsForm.gzip_enabled = false;
                        this.siteSettingsForm.zstd_enabled = false;
                    }
                },

                async saveSiteSettings() {
                    if (!this.managingSite) return;
                    this.siteSettingsError = '';
                    this.siteSettingsSuccess = '';

                    if (this.siteSettingsForm.compression_enabled && !this.siteSettingsForm.gzip_enabled && !this.siteSettingsForm.zstd_enabled) {
                        this.siteSettingsError = 'Enable at least one compression algorithm (gzip or zstd).';
                        return;
                    }
                    if (this.siteSettingsForm.cache_control_enabled && !this.siteSettingsForm.cache_control_value.trim()) {
                        this.siteSettingsError = 'Cache-Control value is required when caching is enabled.';
                        return;
                    }
                    if (!this.siteSettingsForm.php_memory_limit?.toString().trim()) {
                        this.siteSettingsError = 'PHP memory limit is required.';
                        return;
                    }
                    if (!this.siteSettingsForm.php_post_max_size?.toString().trim()) {
                        this.siteSettingsError = 'PHP post max size is required.';
                        return;
                    }
                    if (!this.siteSettingsForm.php_upload_max_filesize?.toString().trim()) {
                        this.siteSettingsError = 'PHP upload max filesize is required.';
                        return;
                    }
                    if (!Number.isFinite(this.siteSettingsForm.php_max_execution_time) || this.siteSettingsForm.php_max_execution_time < 1) {
                        this.siteSettingsError = 'PHP max execution time must be at least 1 second.';
                        return;
                    }
                    if (!Number.isFinite(this.siteSettingsForm.php_max_input_vars) || this.siteSettingsForm.php_max_input_vars < 100) {
                        this.siteSettingsError = 'PHP max input vars must be at least 100.';
                        return;
                    }

                    this.savingSiteSettings = true;
                    try {
                        await this.api(`/sites/${this.managingSite.id}/settings`, 'PUT', {
                            force_https: this.siteSettingsForm.force_https,
                            compression_enabled: this.siteSettingsForm.compression_enabled,
                            gzip_enabled: this.siteSettingsForm.gzip_enabled,
                            zstd_enabled: this.siteSettingsForm.zstd_enabled,
                            cache_control_enabled: this.siteSettingsForm.cache_control_enabled,
                            cache_control_value: this.siteSettingsForm.cache_control_value,
                            php_version: this.siteSettingsForm.php_version,
                            php_memory_limit: this.siteSettingsForm.php_memory_limit,
                            php_post_max_size: this.siteSettingsForm.php_post_max_size,
                            php_upload_max_filesize: this.siteSettingsForm.php_upload_max_filesize,
                            php_max_execution_time: this.siteSettingsForm.php_max_execution_time,
                            php_max_input_vars: this.siteSettingsForm.php_max_input_vars
                        });
                        this.siteSettingsSuccess = 'Site settings saved.';
                        await this.refreshManagingSite();
                    } catch (e) {
                        this.siteSettingsError = e.message || 'Failed to save site settings';
                    } finally {
                        this.savingSiteSettings = false;
                    }
                },

                async addDomain() {
                    this.domainLoading = true;
                    this.domainError = '';
                    try {
                        await this.api(`/sites/${this.managingSite.id}/domains`, 'POST', this.newDomain);
                        this.newDomain = { domain: '', redirect_to_primary: false };
                        await this.refreshManagingSite();
                    } catch (e) {
                        this.domainError = e.message || 'Failed to add domain';
                    } finally {
                        this.domainLoading = false;
                    }
                },

                async toggleRedirect(domain, enable) {
                    this.domainError = '';
                    try {
                        await this.api(`/sites/domains/${domain.id}`, 'PUT', { redirect_to_primary: enable });
                        await this.refreshManagingSite();
                    } catch (e) {
                        this.domainError = e.message || 'Failed to update domain';
                    }
                },

                async setPrimaryDomain(domain) {
                    this.domainError = '';
                    try {
                        await this.api(`/sites/domains/${domain.id}/set-primary`, 'POST');
                        await this.refreshManagingSite();
                    } catch (e) {
                        this.domainError = e.message || 'Failed to set primary domain';
                    }
                },

                async deleteDomain(domain) {
                    const confirmed = await this.askConfirmation({
                        title: 'Remove Domain',
                        message: `Remove ${domain.domain} from this site?`,
                        confirmText: 'Remove Domain'
                    });
                    if (!confirmed) return;
                    this.domainError = '';
                    try {
                        await this.api(`/sites/domains/${domain.id}`, 'DELETE');
                        await this.refreshManagingSite();
                    } catch (e) {
                        this.domainError = e.message || 'Failed to delete domain';
                    }
                },

                async refreshManagingSite() {
                    await Promise.all([
                        this.loadSites(),
                        this.refreshAvailablePHPVersions()
                    ]);
                    if (this.managingSite) {
                        this.managingSite = this.sites.find(s => s.id === this.managingSite.id);
                        if (this.managingSite) {
                            this.siteSettingsForm = {
                                force_https: this.managingSite.force_https !== false,
                                compression_enabled: this.managingSite.compression_enabled !== false,
                                gzip_enabled: this.managingSite.gzip_enabled !== false,
                                zstd_enabled: this.managingSite.zstd_enabled !== false,
                                cache_control_enabled: this.managingSite.cache_control_enabled === true,
                                cache_control_value: this.managingSite.cache_control_value || '',
                                php_version: this.managingSite.php_version || '8.4',
                                php_memory_limit: this.managingSite.php_memory_limit || '256M',
                                php_post_max_size: this.managingSite.php_post_max_size || '64M',
                                php_upload_max_filesize: this.managingSite.php_upload_max_filesize || '64M',
                                php_max_execution_time: Number.isFinite(this.managingSite.php_max_execution_time) ? this.managingSite.php_max_execution_time : 300,
                                php_max_input_vars: Number.isFinite(this.managingSite.php_max_input_vars) ? this.managingSite.php_max_input_vars : 5000
                            };
                            const phpOptions = this.getAvailablePHPVersions();
                            if (!phpOptions.includes(this.siteSettingsForm.php_version)) {
                                this.siteSettingsForm.php_version = phpOptions[0];
                            }
                        }
                    }
                },

                async createDatabase() {
                    const result = await this.api('/databases', 'POST', this.newDatabase);
                    this.createdDatabase = result;
                    this.showCreateDatabase = false;
                    this.newDatabase = { name: '' };
                    this.loadDatabases();
                },

                async deleteDatabase(db) {
                    const confirmed = await this.askConfirmation({
                        title: 'Delete Database',
                        message: `Delete ${db.db_name}? This cannot be undone.`,
                        confirmText: 'Delete Database'
                    });
                    if (!confirmed) return;
                    this.deletingDatabaseId = db.id;
                    try {
                        await this.api(`/databases/${db.id}`, 'DELETE');
                        await this.loadDatabases();
                    } catch (e) {
                        alert('Failed to delete database: ' + (e.message || 'Unknown error'));
                    } finally {
                        this.deletingDatabaseId = null;
                    }
                },
                async resetDatabasePassword(db) {
                    const confirmed = await this.askConfirmation({
                        title: 'Reset Database Password',
                        message: `Reset password for ${db.db_name}? Existing app/database connections using the old password will stop working until updated.`,
                        confirmText: 'Reset Password'
                    });
                    if (!confirmed) return;
                    const result = await this.api(`/databases/${db.id}/reset-password`, 'POST');
                    this.resetDatabaseResult = result;
                },

                async openInPhpMyAdmin(db) {
                    try {
                        const resp = await this.api(`/databases/${db.id}/phpmyadmin`);
                        if (resp.url) {
                            window.open(resp.url, '_blank');
                        }
                    } catch(e) {
                        alert('Could not open phpMyAdmin: ' + e.message + '\n\nNote: Databases created before this feature do not have stored credentials.');
                    }
                },

                async addSSHKey() {
                    this.sshKeyError = '';
                    try {
                        await this.api('/ssh-keys', 'POST', this.newSSHKey);
                        this.showAddSSHKey = false;
                        this.newSSHKey = { name: '', public_key: '' };
                        this.loadSSHKeys();
                    } catch (e) {
                        this.sshKeyError = e.message || 'Failed to add SSH key';
                    }
                },

                async deleteSSHKey(key) {
                    const confirmed = await this.askConfirmation({
                        title: 'Remove SSH Key',
                        message: `Remove "${key.name}"?`,
                        confirmText: 'Remove Key'
                    });
                    if (!confirmed) return;
                    await this.api(`/ssh-keys/${key.id}`, 'DELETE');
                    this.loadSSHKeys();
                },

                // Cron job methods
                async createCronJob() {
                    this.cronError = '';
                    try {
                        await this.api('/cron', 'POST', {
                            name: this.cronForm.name,
                            expression: this.cronForm.expression,
                            command: this.cronForm.command
                        });
                        this.showCronCreateForm = false;
                        this.resetCronForm();
                        this.loadCronJobs();
                    } catch (e) {
                        this.cronError = e.message;
                    }
                },

                async updateCronJob() {
                    this.cronError = '';
                    try {
                        await this.api(`/cron/${this.cronForm.id}`, 'PUT', {
                            name: this.cronForm.name,
                            expression: this.cronForm.expression,
                            command: this.cronForm.command,
                            enabled: this.cronForm.enabled
                        });
                        this.showEditCron = false;
                        this.resetCronForm();
                        this.loadCronJobs();
                    } catch (e) {
                        this.cronError = e.message;
                    }
                },

                editCronJob(job) {
                    this.cronForm = {
                        id: job.id,
                        name: job.name,
                        expression: job.expression,
                        command: job.command,
                        enabled: job.enabled
                    };
                    this.cronValidation = { valid: true, description: job.description, error: '' };
                    this.showEditCron = true;
                },

                async toggleCronJob(job) {
                    try {
                        await this.api(`/cron/${job.id}/toggle`, 'POST', { enabled: !job.enabled });
                        this.loadCronJobs();
                    } catch (e) {
                        console.error('Failed to toggle cron job:', e);
                    }
                },

                async deleteCronJob(job) {
                    const confirmed = await this.askConfirmation({
                        title: 'Delete Cron Job',
                        message: `Delete cron job "${job.name}"?`,
                        confirmText: 'Delete Job'
                    });
                    if (!confirmed) return;
                    await this.api(`/cron/${job.id}`, 'DELETE');
                    this.loadCronJobs();
                },

                resetCronForm() {
                    this.cronForm = { id: '', name: '', expression: '', command: '' };
                    this.cronValidation = { valid: null, description: '', error: '' };
                    this.cronError = '';
                    this.cronHelperMessage = '';
                },

                setCronPreset(expr) {
                    this.cronForm.expression = expr;
                    this.validateCronExpression();
                },

                async validateCronExpression() {
                    clearTimeout(this.cronValidateTimeout);
                    const expr = this.cronForm.expression;
                    if (!expr.trim()) {
                        this.cronValidation = { valid: null, description: '', error: '' };
                        return;
                    }
                    
                    this.cronValidateTimeout = setTimeout(async () => {
                        try {
                            const result = await this.api('/cron/validate', 'POST', { expression: expr });
                            this.cronValidation = {
                                valid: result.valid,
                                description: result.description,
                                error: result.error
                            };
                        } catch (e) {
                            this.cronValidation = { valid: false, description: '', error: 'Validation failed' };
                        }
                    }, 300);
                },
                cronPHPCLIPaths() {
                    const versions = this.getAvailablePHPVersions();
                    const paths = ['/usr/bin/php'];
                    for (const v of versions) {
                        const version = (v || '').toString().trim();
                        if (!version) continue;
                        paths.push(`/usr/bin/php${version}`);
                    }
                    return [...new Set(paths)];
                },
                async copyCronPath(path) {
                    const value = (path || '').toString().trim();
                    if (!value) return;
                    try {
                        if (navigator?.clipboard?.writeText) {
                            await navigator.clipboard.writeText(value);
                            this.cronHelperMessage = `Copied ${value}`;
                            setTimeout(() => { this.cronHelperMessage = ''; }, 1800);
                            return;
                        }
                    } catch (_e) {}
                    window.prompt('Copy PHP path:', value);
                },

                openImpersonateUser(u) {
                    this.impersonationError = '';
                    this.impersonateForm = {
                        target_username: u.username || '',
                        admin_password: '',
                        reason: ''
                    };
                    this.showImpersonateUserModal = true;
                },
                async startImpersonation() {
                    this.impersonationError = '';
                    if (!this.impersonateForm.target_username) {
                        this.impersonationError = 'Target user is required.';
                        return;
                    }
                    if (!this.impersonateForm.admin_password) {
                        this.impersonationError = 'Admin password confirmation is required.';
                        return;
                    }
                    this.impersonationStarting = true;
                    try {
                        const currentToken = this.token;
                        if (!currentToken) throw new Error('Current admin session is missing.');
                        const result = await this.api('/admin/impersonate', 'POST', {
                            target_username: this.impersonateForm.target_username,
                            admin_password: this.impersonateForm.admin_password,
                            reason: (this.impersonateForm.reason || '').trim()
                        });
                        localStorage.setItem(ADMIN_IMPERSONATION_BACKUP_TOKEN_KEY, currentToken);
                        localStorage.setItem(ADMIN_IMPERSONATION_BACKUP_USER_KEY, this.user?.username || '');
                        this.token = result.token;
                        localStorage.setItem('fastcp_token', this.token);
                        this.user = result.user;
                        this.showImpersonateUserModal = false;
                        this.impersonateForm = { target_username: '', admin_password: '', reason: '' };
                        window.location.hash = 'dashboard';
                        this.handleHashRoute();
                    } catch (e) {
                        this.impersonationError = e.message || 'Failed to start impersonation';
                    } finally {
                        this.impersonationStarting = false;
                    }
                },
                async stopImpersonation() {
                    if (this.impersonationStopping) return;
                    this.impersonationStopping = true;
                    try {
                        await this.api('/auth/impersonation/stop', 'POST', {});
                    } catch (_e) {
                        // Continue with local token restore/log out even if server-side stop had an error.
                    }
                    const adminToken = localStorage.getItem(ADMIN_IMPERSONATION_BACKUP_TOKEN_KEY);
                    localStorage.removeItem(ADMIN_IMPERSONATION_BACKUP_TOKEN_KEY);
                    localStorage.removeItem(ADMIN_IMPERSONATION_BACKUP_USER_KEY);
                    if (!adminToken) {
                        await this.logout();
                        this.impersonationStopping = false;
                        return;
                    }
                    this.token = adminToken;
                    localStorage.setItem('fastcp_token', adminToken);
                    try {
                        await this.fetchUser();
                        this.tab = this.user?.is_admin ? 'users' : 'dashboard';
                        window.location.hash = this.tab;
                        this.loadTabData(this.tab);
                    } catch (_e) {
                        await this.logout();
                    } finally {
                        this.impersonationStopping = false;
                    }
                },

                async createUser() {
                    this.userError = '';
                    this.creatingUser = true;
                    try {
                        await this.api('/users', 'POST', this.newUser);
                        this.showCreateUser = false;
                        this.newUser = { username: '', password: '', is_admin: false, memory_mb: 512, cpu_percent: 100, max_sites: -1, storage_mb: -1 };
                        this.loadUsers();
                    } catch(e) {
                        this.userError = e.message;
                    } finally {
                        this.creatingUser = false;
                    }
                },
                openEditUserResources(u) {
                    this.editingUserResources = u;
                    this.editUserResourcesForm = {
                        memory_mb: u.memory_mb ?? 512,
                        cpu_percent: u.cpu_percent ?? 100,
                        max_sites: u.max_sites ?? -1,
                        storage_mb: u.storage_mb ?? -1
                    };
                    this.editUserResourcesError = '';
                    this.showEditUserResources = true;
                },
                async saveUserResources() {
                    if (!this.editingUserResources) return;
                    this.editUserResourcesError = '';
                    const memoryMB = parseInt(this.editUserResourcesForm.memory_mb, 10);
                    const cpuPercent = parseInt(this.editUserResourcesForm.cpu_percent, 10);
                    const maxSites = parseInt(this.editUserResourcesForm.max_sites, 10);
                    const storageMB = parseInt(this.editUserResourcesForm.storage_mb, 10);

                    if (!Number.isFinite(memoryMB) || (memoryMB !== -1 && (memoryMB < 128 || memoryMB > 262144))) {
                        this.editUserResourcesError = 'Memory must be -1 (unlimited) or between 128 and 262144 MB.';
                        return;
                    }
                    if (!Number.isFinite(cpuPercent) || (cpuPercent !== -1 && (cpuPercent < 10 || cpuPercent > 4000))) {
                        this.editUserResourcesError = 'CPU must be -1 (unlimited) or between 10 and 4000%.';
                        return;
                    }
                    if (!Number.isFinite(maxSites) || maxSites < -1) {
                        this.editUserResourcesError = 'Max sites must be -1 or greater.';
                        return;
                    }
                    if (!Number.isFinite(storageMB) || storageMB < -1) {
                        this.editUserResourcesError = 'Storage must be -1 or greater.';
                        return;
                    }

                    this.savingUserResources = true;
                    try {
                        await this.api(`/users/${this.editingUserResources.username}/resources`, 'PUT', {
                            memory_mb: memoryMB,
                            cpu_percent: cpuPercent,
                            max_sites: maxSites,
                            storage_mb: storageMB
                        });
                        this.showEditUserResources = false;
                        this.editingUserResources = null;
                        await this.loadUsers();
                    } catch (e) {
                        this.editUserResourcesError = e.message || 'Failed to update user limits';
                    } finally {
                        this.savingUserResources = false;
                    }
                },

                async deleteUser(u) {
                    const confirmed = await this.askConfirmation({
                        title: 'Delete User',
                        message: `Delete user "${u.username}"? This will delete all their sites, databases, and SSH keys.`,
                        confirmText: 'Delete User'
                    });
                    if (!confirmed) return;
                    this.deletingUser = u.username;
                    try {
                        await this.api(`/users/${u.username}`, 'DELETE');
                        this.loadUsers();
                    } catch(e) {
                        alert('Failed to delete user: ' + e.message);
                    } finally {
                        this.deletingUser = null;
                    }
                },

                async toggleUserSuspension(u) {
                    const action = u.is_suspended ? 'unsuspend' : 'suspend';
                    if (!confirm(`${action.charAt(0).toUpperCase() + action.slice(1)} user "${u.username}"?`)) return;
                    this.suspendingUser = u.username;
                    try {
                        await this.api(`/users/${u.username}/toggle-suspend`, 'POST');
                        this.loadUsers();
                    } catch(e) {
                        alert('Failed to ' + action + ' user: ' + e.message);
                    } finally {
                        this.suspendingUser = null;
                    }
                },

                async checkUpdate(force = false) {
                    this.updateChecking = true;
                    try {
                        const query = force ? '?force=1' : '';
                        this.updateInfo = await this.api('/system/check-update' + query);
                        this.updateError = this.updateInfo?.warning || '';
                    } catch (e) {
                        if (force) {
                            this.updateError = 'Unable to check for updates right now.';
                        }
                        console.error('Failed to check for updates:', e);
                    } finally {
                        this.updateChecking = false;
                    }
                },

                async performUpdate() {
                    if (!confirm(`Update FastCP to ${this.updateInfo.latest_version}? The control panel will restart.`)) return;
                    this.updateLoading = true;
                    this.updateError = '';
                    this.updateProgress = 5;
                    this.updateStatus = `Starting update to ${this.updateInfo.latest_version}...`;

                    this.api('/system/update', 'POST', { target_version: this.updateInfo.latest_version }).catch(() => {});
                    
                    let attempts = 0;
                    const maxAttempts = 90;
                    const checkServer = async () => {
                        attempts++;
                        if (attempts <= 8) {
                            this.updateStatus = 'Downloading update binaries...';
                            this.updateProgress = Math.min(35, 8 + attempts * 3);
                        } else if (attempts <= 20) {
                            this.updateStatus = 'Installing new version...';
                            this.updateProgress = Math.min(65, 35 + (attempts - 8) * 2.5);
                        } else if (attempts <= 35) {
                            this.updateStatus = 'Restarting FastCP services...';
                            this.updateProgress = Math.min(85, 65 + (attempts - 20) * 1.3);
                        } else {
                            this.updateStatus = 'Waiting for control panel to come back online...';
                            this.updateProgress = Math.min(95, 85 + (attempts - 35) * 0.3);
                        }

                        try {
                            const resp = await fetch('/api/system/status', {
                                headers: { 'Authorization': `Bearer ${this.token}` }
                            });
                            if (resp.ok) {
                                this.updateStatus = 'Update completed. Reloading...';
                                this.updateProgress = 100;
                                window.location.reload();
                                return;
                            }
                        } catch (e) {}
                        
                        if (attempts < maxAttempts) {
                            setTimeout(checkServer, 2000);
                        } else {
                            this.updateError = 'Update is taking longer than expected. It may still be running on the server. Please refresh in a moment and check version status.';
                            this.updateStatus = '';
                            this.updateLoading = false;
                            this.updateProgress = 0;
                        }
                    };
                    
                    setTimeout(checkServer, 3000);
                },

                async api(path, method = 'GET', body = null) {
                    const opts = {
                        method,
                        headers: { 'Authorization': `Bearer ${this.token}`, 'Content-Type': 'application/json' }
                    };
                    if (body) opts.body = JSON.stringify(body);
                    const resp = await fetch(`${API}${path}`, opts);
                    if (resp.status === 401) { this.logout(); throw new Error('Session expired'); }
                    if (resp.status === 204) return null;
                    const data = await resp.json();
                    if (!resp.ok) throw new Error(data.error || 'Request failed');
                    return data;
                },

                formatDate(d) { return d ? new Date(d).toLocaleDateString() : '-'; },
                formatDateTime(d) { return d ? new Date(d).toLocaleString() : '-'; },
                formatBytes(b) {
                    if (!b) return '-';
                    const u = ['B','KB','MB','GB','TB'];
                    let i = 0;
                    while (b >= 1024 && i < u.length-1) { b /= 1024; i++; }
                    return b.toFixed(1) + ' ' + u[i];
                },
                formatUptime(s) {
                    if (!s) return '-';
                    const d = Math.floor(s/86400), h = Math.floor((s%86400)/3600);
                    return d > 0 ? `${d}d ${h}h` : `${h}h ${Math.floor((s%3600)/60)}m`;
                }
            };
        }
    </script>
</body>
</html>
